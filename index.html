<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="format-detection" content="telephone=no" />
  <title>HMA Paving</title>
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png" />
  <link rel="shortcut icon" href="icons/icon-192x192.png" type="image/png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


  <style>
    :root {
      --primary: #2b5797;
      --secondary: #4472c4;
      --accent: #ed7d31;
      --light: #f4f4f4;
      --dark: #333;
      --success: #5cb85c;
      --danger: #d9534f;
      --warning: #f0ad4e;

      /* Light Mode Colors (default) */
      --background: var(--light);
      --card-bg: white;
      --text-color: var(--dark);
      --input-bg: #f9f9f9;
      --input-border: #ddd;
      --table-even: #f2f2f2;
      --table-hover: #e2e2e2;
      --border-color: #ddd;
      --hamburger-color: var(--primary);
    }

    /* Dark Mode Colors */
    [data-theme="dark"] {
      --background: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --input-bg: #2d2d2d;
      --input-border: #444;
      --table-even: #2a2a2a;
      --table-hover: #363636;
      --border-color: #444;
      --hamburger-color: var(--accent);
    }

    /* Prevent overscroll bounce effects */
    html, body {
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-touch-callout: none; /* Disable callout to save image etc on iOS */
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
    }

    body {
      background-color: var(--background);
      color: var(--text-color);
      line-height: 1.4;
      padding: 10px;
      font-size: 14px; /* Reduced base font size */
      transition: background-color 0.3s ease, color 0.3s ease;
      touch-action: pan-y; /* Allow only vertical scrolling */
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px;
      padding-top: 5px; /* Reduced from 15px */
      background: var(--card-bg);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      position: relative;
      transition: background-color 0.3s ease;
      height: calc(100vh - 20px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
      overscroll-behavior: contain; /* Prevent bounce while allowing scrolling */
    }

    header {
      text-align: center;
      margin-bottom: 3px;
      padding-bottom: 2px;
      border-bottom: 1px solid var(--border-color);
      padding-top: 0; /* Reduced from 5px */
      transition: border-color 0.3s ease;
      position: relative; /* Add position relative */
      height: 35px; /* Fix header height */
      display: flex; /* Use flexbox */
      justify-content: center; /* Center the date */
      align-items: center; /* Vertically center content */
    }

    h1 {
      color: var(--primary);
      font-size: 1.2rem; /* Reduced header font */
      margin-bottom: 10px;
    }

    /* Tab Container Styling */
    .tab-container {
      margin-bottom: 10px;
    }

    .tab-buttons {
      display: none; /* Hide the original tab buttons */
    }

    .tab-button {
      flex: 1;
      background-color: #e2e2e2;
      border: none;
      padding: 10px;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .tab-button.active {
      background-color: var(--primary);
      color: #fff;
    }

    /* Custom scrolling for tab content to work with fixed body */
    .tab-content {
      display: none;
      padding: 10px;
      max-height: calc(100vh - 120px); /* Adjust as needed */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab-content.active {
      display: block;
    }

    /* Add responsive layout styling for the side-by-side arrangement */
    .flex-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .flex-container > * {
      flex: 1;
      min-width: 280px; /* Reduced from 300px to allow more flexibility */
    }

    .input-section {
      background-color: var(--input-bg);
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      flex: 2; /* Give input section more space */
      transition: background-color 0.3s ease;
    }

    .input-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .results-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    .current-results, .run-summary-results, .day-summary-results { /* Updated class name */
      background-color: var(--input-bg);
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 10px; /* Adjusted from 15px */
      transition: background-color 0.3s ease;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      font-size: 0.9rem; /* Slightly smaller result font */
    }

    .result-label {
      font-weight: bold;
      margin-right: 5px;
    }

    /* Data Table */
    .data-table-container {
      overflow-x: auto;
      max-width: 100%;
      margin-top: 10px;
      max-height: calc(100vh - 250px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      text-align: center; /* Center child elements */
    }

    .truck-data-table {
      width: 80% !important; /* More reasonable width that won't cause layout issues */
      display: inline-block; /* Allow centering through text-align */
      margin: 0 auto !important;
      border-collapse: collapse;
      min-width: unset !important;
    }

    .truck-data-table th,
    .truck-data-table td {
      padding: 6px; /* Reduced padding */
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      border-right: 1px solid rgba(221, 221, 221, 0.4); /* Lighter vertical line between columns */
      font-size: 0.85rem; /* Reduced font size */
      transition: border-color 0.3s ease;
      /* 11. Improve Mobile Display: word break */
      word-break: break-word;
      white-space: normal; /* Allow wrapping */
    }
    
    /* Remove border from last column */
    .truck-data-table th:last-child,
    .truck-data-table td:last-child {
      border-right: none;
    }
    
    /* Add slightly different border color for dark mode */
    [data-theme="dark"] .truck-data-table th,
    [data-theme="dark"] .truck-data-table td {
      border-right: 1px solid rgba(68, 68, 68, 0.4);
    }
    
    [data-theme="dark"] .truck-data-table th:last-child,
    [data-theme="dark"] .truck-data-table td:last-child {
      border-right: none;
    }

    /* 11. Improve Mobile Display: Adjust column widths (example) */
    .truck-data-table th:nth-child(1), /* Load # */
    .truck-data-table td:nth-child(1) { width: 10%; }
    .truck-data-table th:nth-child(2), /* Start Sta */
    .truck-data-table td:nth-child(2) { width: 12%; }
    .truck-data-table th:nth-child(3), /* End Sta */
    .truck-data-table td:nth-child(3) { width: 12%; }
    .truck-data-table th:nth-child(4), /* Length */
    .truck-data-table td:nth-child(4) { width: 10%; }
    .truck-data-table th:nth-child(5), /* Width */
    .truck-data-table td:nth-child(5) { width: 10%; }
    /* Others can take remaining space */


    .truck-data-table tr:nth-child(even) {
      background-color: var(--table-even);
      transition: background-color 0.3s ease;
    }

    .truck-data-table tr:hover {
      background-color: var(--table-hover);
      transition: background-color 0.3s ease;
    }

    .truck-data-table th {
      background-color: var(--primary);
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1; /* Ensure header stays above scrolling content */
    }

    .truck-data-table tfoot {
      font-weight: bold;
      background-color: var(--secondary);
      color: #fff;
    }

    .truck-data-table tfoot td {
      border-top: 2px solid var(--primary);
    }

    /* 10. Visual Separators for Archive */
    .run-separator td {
        border-top: 3px solid var(--primary) !important;
        border-bottom: 1px solid var(--primary) !important;
        background-color: var(--secondary) !important;
        color: white !important;
        font-weight: bold;
        font-size: 0.8rem !important;
        padding: 5px !important;
        text-align: center;
    }
    .run-separator td span {
        display: block;
        margin-top: 3px;
        font-weight: normal;
        font-style: italic;
        font-size: 0.75rem;
    }


    .delete-btn {
      color: var(--danger);
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1rem;
      text-align: center;
      transition: transform 0.2s;
    }

    .delete-btn:hover {
      transform: scale(1.2);
    }

    /* Utility Classes */
    .hidden {
      display: none;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 6px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Added new CSS rules for responsive Today's Runs table */
    .truck-data-table th,
    .truck-data-table td {
      white-space: nowrap;
    }

    @media (min-width: 600px) {
      .input-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 900px) {
      .input-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Mobile layout adjustments */
    @media (max-width: 768px) {
      .flex-container {
        flex-direction: column; /* Stack vertically on mobile */
      }

      .flex-container > * {
        min-width: 100%; /* Full width for children */
        width: 100%;
      }

      .input-section, .results-container {
        flex-basis: auto; /* Reset flex-basis */
      }

      /* Keep two columns for input grid if possible */
      .input-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 5px;
      }

      .form-group label {
        font-size: 0.8rem;
        margin-bottom: 2px;
      }

      .form-group input {
        padding: 4px;
        font-size: 0.8rem;
        min-width: 0;
        width: 100%;
      }

      /* Stack results vertically */
      .results-container {
        flex-direction: column;
      }

      .current-results, .run-summary-results, .day-summary-results {
        flex-basis: auto;
        padding: 4px;
        margin-bottom: 4px;
      }

      /* Modify button stack behavior - keep horizontal for undo/save buttons but vertical for others */
      .button-group {
        flex-direction: row; /* Keep buttons horizontal by default */
        align-items: stretch;
        gap: 2px; /* Reduced gap for tighter spacing */
      }
      
      /* Target only the button group in results container to keep those stacked */
      .results-container .button-group {
        flex-direction: column; /* Stack buttons vertically */
        align-items: stretch; /* Make buttons full width */
      }
      
      .results-container .button-group button {
        width: 100%;
        margin-bottom: 5px;
      }
      
      .results-container .button-group button:last-child {
        margin-bottom: 0;
      }


      .result-row {
        font-size: 0.8rem;
      }

      h2 {
        font-size: 1rem;
        margin: 0 0 5px 0;
      }

      .container {
        padding: 3px;
        padding-top: 5px; /* Reduced top padding */
      }

      .tab-content {
        padding: 3px;
        max-height: calc(100vh - 100px); /* Adjusted for mobile */
      }

      .input-section {
        padding: 6px;
        margin-bottom: 5px;
      }

      header {
        margin-bottom: 5px;
        padding-bottom: 2px;
        height: 30px; /* Slightly reduce header height on mobile */
      }

      .current-date {
        font-size: 0.8rem;
      }
      
      /* Adjust hamburger menu position for better alignment on mobile */
      .hamburger-menu {
        top: 3px; /* Adjust to vertically center with date */
        left: 10px; /* Move slightly closer to edge on small screens */
      }

       /* 11. Improve Mobile Display: Further optimization for data tables */
      .truck-data-table th,
      .truck-data-table td {
          padding: 4px; /* Even smaller padding */
          font-size: 0.75rem; /* Smaller font */
      }
      .truck-data-table tfoot td {
          font-size: 0.8rem;
      }
       .data-table-container {
           max-height: calc(100vh - 300px); /* Adjust based on other elements */
       }

      /* Make sure the table remains centered on mobile but adjust width for readability */
      .data-table-container {
        text-align: center;
        overflow-x: auto;
      }
      
      .truck-data-table {
        width: 95% !important; /* Wider on mobile for readability */
      }
    }

    /* Form & Input Styling */
    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 0.9rem;
      font-weight: bold;
      margin-bottom: 3px;
    }

    input, button, select {
      padding: 5px;
      font-size: 0.9rem;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background-color: var(--input-bg);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      width: 100%; /* Make inputs use full width of container */
      box-sizing: border-box; /* Include padding and border in the width */
    }

    button {
      background-color: var(--primary);
      color: #fff;
      cursor: pointer;
      border: none;
      font-weight: bold;
      transition: background-color 0.3s;
      margin-top: 5px;
    }

    button:hover {
      background-color: var(--secondary);
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .button-group {
      display: flex;
      gap: 10px; /* Increased gap */
      margin-top: 15px; /* Adjusted from 20px */
      margin-bottom: 10px; /* Adjusted from 20px */
      justify-content: center; /* Center the buttons horizontally */
      flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
    }

    /* Specific button styling */
    .action-btn {
      padding: 8px 12px; /* Standardized padding */
      font-size: 0.95rem; /* Standardized font size */
      font-weight: bold;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      flex: 1; /* Allow buttons to grow */
      min-width: 120px; /* Minimum width */
    }
     .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .start-run-btn { background-color: #1e88e5; } /* Blue color for Start Run button in light mode */
    [data-theme="dark"] .start-run-btn { background-color: var(--accent); } /* Keep accent color for dark mode */
    .save-btn { background-color: var(--success); }
    .undo-btn { background-color: var(--warning); color: var(--dark); }


    /* Results Sections */
    .results-section {
      margin-top: 15px; /* Adjusted from 20px */
    }

    /* Add hamburger menu styles */
    .hamburger-menu {
      display: inline-block;
      cursor: pointer;
      position: absolute;
      top: 16px; /* Adjusted to be in-line with the date */
      left: 20px;
      z-index: 100;
    }

    .hamburger-icon {
      width: 30px;
      height: 23px;
      position: relative;
      transform: rotate(0deg);
      transition: .3s ease-in-out;
    }

    .hamburger-icon span {
      display: block;
      position: absolute;
      height: 3px;
      width: 100%;
      background: var(--hamburger-color);
      border-radius: 3px;
      opacity: 1;
      left: 0;
      transform: rotate(0deg);
      transition: .15s ease-in-out, background-color 0.3s ease;
    }

    .hamburger-icon span:nth-child(1) { top: 0px; }
    .hamburger-icon span:nth-child(2) { top: 10px; }
    .hamburger-icon span:nth-child(3) { top: 20px; }
    .hamburger-icon.open span:nth-child(1) { top: 10px; transform: rotate(45deg); }
    .hamburger-icon.open span:nth-child(2) { opacity: 0; left: -30px; }
    .hamburger-icon.open span:nth-child(3) { top: 10px; transform: rotate(-45deg); }

    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background-color: var(--card-bg);
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      transition: left 0.3s;
      z-index: 99;
      padding-top: 60px;
      overflow-y: auto;
      color: var(--text-color);
      transition: background-color 0.3s ease, left 0.3s, color 0.3s ease;
    }

    .sidebar.open { left: 0; }
    .sidebar-menu { list-style: none; padding: 0; }
    .sidebar-menu li {
      padding: 12px 15px; /* Slightly reduced padding */
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      font-weight: bold;
      font-size: 0.95rem; /* Slightly smaller font */
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    .sidebar-menu li:hover { background-color: var(--accent); color: white; }

    /* Removed #exportAllDataButton styles */

    .sidebar-menu li.active {
      background-color: var(--primary);
      color: white;
      border-left: 4px solid var(--accent);
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 98;
      visibility: hidden;
      opacity: 0;
      transition: 0.3s;
    }
    .overlay.open { visibility: visible; opacity: 1; }

    /* Current date display */
    .current-date {
      text-align: center;
      font-weight: bold;
      color: var(--primary);
      padding: 0; /* Remove padding */
      font-size: 0.9rem;
      margin: 0; /* Remove margin */
    }
    [data-theme="dark"] .current-date { color: var(--accent); }

    /* Archive Modal Styles */
    #archiveModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .archive-modal-content {
      position: relative;
      background-color: var(--card-bg);
      margin: auto; /* Changed from 5% auto to auto for vertical centering */
      padding: 15px; /* Reduced padding */
      width: 95%; /* Wider */
      max-width: 900px; /* Max width */
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
      display: flex; /* Use flexbox for layout */
      flex-direction: column;
      max-height: 90vh; /* Limit height */
      top: 50%; /* Position at 50% from the top */
      transform: translateY(-50%); /* Move up by half of its height */
    }

    .archive-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
    }

    #archiveModal .data-table-container {
        flex-grow: 1; /* Allow table container to fill space */
        max-height: calc(85vh - 150px); /* Adjust based on header/footer */
        margin-bottom: 10px;
        text-align: center; /* Center child elements including tables */
    }


    @media (max-width: 768px) {
      .archive-modal-content {
        margin: auto; /* Changed from 2% auto to auto for vertical centering */
        padding: 10px;
        width: 98%;
        max-height: 95vh;
      }
       #archiveModal .data-table-container {
           max-height: calc(90vh - 130px);
       }
    }

    /* Dark Mode Toggle Styles */
    .sidebar-menu .divider {
      border-bottom: 1px solid var(--border-color);
      margin: 8px 0;
      pointer-events: none;
      padding: 0;
      height: 0;
      opacity: 0.7;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(128, 128, 128, 0.1);
    }

    .toggle-switch {
      display: inline-block;
      background: rgba(150, 150, 150, 0.4);
      border-radius: 12px;
      width: 42px;
      height: 22px;
      position: relative;
      vertical-align: middle;
      transition: background 0.25s;
      cursor: pointer;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.4);
      margin-left: 10px;
    }
    .toggle-switch:before, .toggle-switch:after { content: ""; }
    .toggle-switch:before {
      display: block;
      background: #fff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      position: absolute;
      top: 3px;
      left: 3px;
      transition: all 0.25s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }
    .toggle-switch.active { background: var(--accent); }
    .toggle-switch.active:before { left: 23px; background-color: #fff; }
    .toggle-switch:after {
      /* content: "☼"; */ /* Removed icon */
      position: absolute; /* Keep position for potential future structure */
      /* right: 5px; */
      /* top: 2px; */
      /* font-size: 12px; */
      /* color: rgba(255, 255, 255, 0.4); */
      /* font-family: sans-serif; */
    }

    /* Calculator results styling */
    #paverSpeedTab .results-container,
    #projLengthTab .results-container,
    #tonnageTab .results-container {
      margin: 15px auto;
      max-width: 300px;
      text-align: center;
      width: 100%;
    }

    #paverSpeedTab .current-results,
    #projLengthTab .current-results,
    #tonnageTab .current-results {
      background-color: var(--input-bg);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #paverSpeedResult,
    #projLengthResult,
    #tonCalcResult {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--primary) !important;
      display: inline-block;
      padding: 2px 10px;
      background-color: rgba(43, 87, 151, 0.1) !important;
      border-radius: 4px;
      min-width: 80px;
      text-align: right;
    }

    [data-theme="dark"] #paverSpeedResult,
    [data-theme="dark"] #projLengthResult,
    [data-theme="dark"] #tonCalcResult {
      color: var(--accent) !important;
      background-color: rgba(237, 125, 49, 0.1) !important;
    }

    #paverSpeedTab .result-row,
    #projLengthTab .result-row,
    #tonnageTab .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 5px;
    }

      #yieldTab .input-section,
      #yieldTab .results-container,
      #yieldTab .current-results,
      #yieldTab .run-summary-results,
      #yieldTab .day-summary-results {
        width: 100%;
        margin: 0 0 8px 0;
        box-sizing: border-box;
      }

      /* Common styling for all calculator tabs */
      #paverSpeedTab .flex-container,
      #projLengthTab .flex-container,
      #tonnageTab .flex-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin: 0;
        width: 100%;
      }

      #paverSpeedTab .input-section,
      #projLengthTab .input-section,
      #tonnageTab .input-section {
        padding: 8px;
        margin: 0 0 5px 0;
        background-color: var(--input-bg);
        border-radius: 5px;
        border: 1px solid var(--input-border);
        width: 100%;
        box-sizing: border-box;
      }

      #paverSpeedTab .results-container,
      #projLengthTab .results-container,
      #tonnageTab .results-container {
        margin: 10px auto; /* Reduced margin */
      }

      #paverSpeedTab,
      #projLengthTab,
      #tonnageTab {
        padding: 3px;
        width: 100%;
        box-sizing: border-box;
      }

      #paverSpeedTab h2,
      #projLengthTab h2,
      #tonnageTab h2 {
        font-size: 0.95rem;
        margin-bottom: 8px;
        text-align: center;
        width: 100%;
      }

      #paverSpeedTab h3,
      #projLengthTab h3,
      #tonnageTab h3 {
        font-size: 0.9rem;
        margin: 0 0 5px 0;
        text-align: center;
        width: 100%;
      }

      /* Create two columns for input fields in calculator tabs */
      #paverSpeedTab .input-grid,
      #projLengthTab .input-grid,
      #tonnageTab .input-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        width: 100%;
      }

      #paverSpeedTab .form-group,
      #projLengthTab .form-group,
      #tonnageTab .form-group {
        margin-bottom: 5px;
        width: 100%;
      }

      #paverSpeedTab .form-group label,
      #projLengthTab .form-group label,
      #tonnageTab .form-group label {
        font-size: 0.75rem;
        margin-bottom: 3px;
        display: block;
      }

      #paverSpeedTab .form-group input,
      #projLengthTab .form-group input,
      #tonnageTab .form-group input {
        font-size: 0.8rem;
        padding: 5px;
        height: 2.2em;
        width: 100%;
        box-sizing: border-box;
        min-width: 0;
      }

      #paverSpeedResult,
      #projLengthResult,
      #tonCalcResult {
        font-size: 1.2rem; /* Slightly smaller on mobile */
      }


    @media (max-width: 360px) { /* Stricter rules for very small screens */
      /* Single column input grid */
      .input-grid,
      #paverSpeedTab .input-grid,
      #projLengthTab .input-grid,
      #tonnageTab .input-grid {
        grid-template-columns: 1fr;
      }

       .form-group input {
        font-size: 0.75rem;
        padding: 3px;
      }
       .form-group label {
        font-size: 0.7rem;
      }

       .results-container { gap: 5px; }
       .current-results, .run-summary-results, .day-summary-results { padding: 6px; margin-bottom: 5px;}
       .result-row { font-size: 0.75rem;}

       h2 { font-size: 0.9rem; }
       .action-btn { font-size: 0.85rem; padding: 6px 10px; min-width: 100px;}

        /* Smaller table fonts */
        .truck-data-table th,
        .truck-data-table td {
          padding: 3px;
          font-size: 0.7rem;
        }
        .truck-data-table tfoot td {
          font-size: 0.75rem;
        }
         .delete-btn { font-size: 1rem;}
    }

    /* New style: shrink table to half its size and center it */
    /* (Removing this duplicated style section) */

    /* Add this at the end of the style section to ensure it overrides all other table styles */
    #truckDataTable, #archiveDataTable {
      width: 80% !important; /* Consistent width for both tables */
      min-width: unset !important;
      display: inline-block !important;
      margin: 0 auto !important;
    }
    
    @media (max-width: 768px) {
      #truckDataTable, #archiveDataTable {
        width: 95% !important; /* Almost full width on mobile */
      }
    }

    /* Remove this duplicate rule */
    /* Ensure archive data table has the same properties */
    /* #archiveDataTable {
      width: 80% !important;
      display: inline-block;
      margin: 0 auto !important;
    } */

    /* Collapsible card styles */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 10px 0;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--input-border);
    }

    .card-header h2 {
      margin: 0;
    }

    .collapse-icon {
      font-size: 1.2em;
      transition: transform 0.3s ease;
    }

    .collapse-icon.collapsed {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.3s ease;
      max-height: 1000px;
    }

    .collapsible-content.collapsed {
      max-height: 0;
    }

    /* Add additional CSS to reduce spacing for h2 elements in result sections */
    .current-results h2, .run-summary-results h2, .day-summary-results h2 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    /* Add styles for editable cells */
    .truck-data-table td[contenteditable="true"] {
      background-color: rgba(255, 255, 255, 0.1);
      cursor: text;
      transition: background-color 0.2s;
      outline: 1px dotted var(--input-border);
    }

    .truck-data-table td[contenteditable="true"]:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .truck-data-table td[contenteditable="true"]:focus {
      background-color: rgba(255, 255, 255, 0.3);
      outline: 2px solid var(--accent);
    }

    /* Indicator for edited cells */
    .cell-edited {
      position: relative;
    }

    .cell-edited::after {
      content: '*';
      position: absolute;
      top: 0;
      right: 3px;
      color: var(--accent);
      font-weight: bold;
    }

    /* Style for editable data tables */
    .editable-mode-active .truck-data-table td:not(.non-editable) {
      cursor: text;
    }

    /* Style for editable remarks */
    .editable-remarks {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 2px 4px;
      border-radius: 3px;
      cursor: text;
      transition: background-color 0.2s;
      outline: 1px dotted var(--input-border);
      display: inline-block;
      min-width: 50px;
    }

    .editable-remarks:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .editable-remarks:focus {
      background-color: rgba(255, 255, 255, 0.3);
      outline: 2px solid var(--accent);
    }

    .editable-remarks.cell-edited {
      position: relative;
    }

    .editable-remarks.cell-edited::after {
      content: '*';
      position: absolute;
      top: 0;
      right: 3px;
      color: var(--accent);
      font-weight: bold;
    }

    /* Save changes button */
    .edit-controls {
      display: none; /* Hidden by default */
      margin: 10px 0;
      text-align: center;
    }

    /* Show controls for current run when dataTab is editable */
    #dataTab.editable-mode-active > .edit-controls:not(#archiveEditControls) {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    /* Show controls for archive modal when its content is editable */
    .archive-modal-content.editable-mode-active #archiveEditControls {
      display: flex;
      justify-content: center;
      gap: 10px;
      /* Remove margin-top since we're adding it inline */
    }


    .editable-mode-active .edit-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    /* Disabled status style for editable mode button */
    .btn-editable-mode[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Hamburger Menu and Sidebar -->
  <div class="hamburger-menu">
    <div class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div class="sidebar">
    <ul class="sidebar-menu">
      <li class="active" data-tab="yieldTab">Yield Calc</li>
      <!-- 8. Data History Label -> Renamed -->
      <li data-tab="dataTab">Current Run / History</li>
      <li data-tab="paverSpeedTab">Paver Speed Calc</li>
      <li data-tab="projLengthTab">Projected Length Calc</li>
      <li data-tab="tonnageTab">Tonnage Calc</li>
      <!-- 13. Remove "Export All Data" -->
      <!-- <li id="exportAllDataButton">Export All Data</li> -->
      <li id="exportDataButton">Export Data</li>
      <li id="aboutButton">About</li>
      <li id="darkModeToggle" class="settings-item">Dark Mode <span class="toggle-switch" id="darkModeSwitch"></span></li>
      <!-- Add new Settings button -->
      <li id="settingsButton">Settings</li>
    </ul>
  </div>

  <div class="overlay"></div>

  <!-- Settings Modal -->
  <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
    <div class="archive-modal-content" style="max-width: 400px;"> <!-- Smaller max-width -->
      <span id="closeSettingsModal" class="archive-close">×</span>
      <h2 style="color: var(--primary); margin-bottom: 15px; text-align: center;">Settings</h2>
      <ul class="sidebar-menu" style="padding-left: 0;"> <!-- Re-use sidebar menu styling for list items -->
        <!-- Moved auto-fill toggle here -->
        <li id="autoFillToggle" class="settings-item" style="border-bottom: none;"> <!-- Remove border from single item -->
          Auto-fill Start Sta. <span class="toggle-switch" id="autoFillSwitch"></span>
        </li>
      </ul>
      <div style="text-align: center; margin-top: 20px;">
        <button id="closeSettingsButton" style="background-color: var(--primary); color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer;">Close</button>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <!-- Current date display -->
      <div class="current-date" id="currentDateDisplay"></div>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-container">

      <!-- ===== Yield Calculator Tab Content ===== -->
      <div class="tab-content active" id="yieldTab">
        <!-- Flex container for layout -->
        <div class="flex-container">
          <!-- Left side: Input fields -->
          <div class="input-section">
            <div class="card-header" id="truckInfoHeader">
              <h2>Truck Information</h2>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="collapsible-content" id="truckInfoContent">
              <div class="input-grid">
                <div class="form-group">
                  <label for="truckNumber">Load Number:</label>
                  <input type="number" id="truckNumber" min="0" step="1" placeholder="Enter load identifier" inputmode="numeric" pattern="[0-9]*" />
                </div>
                <div class="form-group">
                  <label for="truckTonnage">Truck Tonnage (tons):</label>
                  <input type="number" id="truckTonnage" step="0.01" min="0" placeholder="Enter tonnage" inputmode="decimal" />
                </div>
                <div class="form-group">
                  <label for="startValue">Start Sta.:</label>
                  <input type="number" id="startValue" step="0.01" min="0" placeholder="Enter start station" inputmode="decimal" />
                </div>
                <div class="form-group">
                  <label for="endValue">End Sta.:</label>
                  <input type="number" id="endValue" step="0.01" min="0" placeholder="Enter end station" inputmode="decimal" />
                </div>
                <div class="form-group">
                  <label for="width">Width (feet):</label>
                  <input type="number" id="width" step="0.01" min="0" placeholder="Enter width" inputmode="decimal" />
                </div>
                <div class="form-group">
                  <label for="calculatedLength">Calculated Length (feet):</label>
                  <input type="number" id="calculatedLength" readonly />
                </div>
              </div>
              <!-- Buttons below input grid -->
              <div class="button-group">
                <!-- 15. Add Undo Button -->
                <button id="undoButton" class="action-btn undo-btn" disabled>Undo Last Save</button>
                <button id="saveTruckButton" class="action-btn save-btn" disabled>Save Truck Data</button>
              </div>
            </div>
          </div>

          <!-- Right side: Results -->
          <div class="results-container">
            <div class="current-results">
              <h2>Current Truck Results</h2>
              <div class="result-row">
                <span class="result-label">Length (ft):</span>
                <span id="lengthResult">-</span>
              </div>
              <div class="result-row">
                <span class="result-label">Area (sq yd):</span>
                <span id="areaResult">-</span>
              </div>
              <div class="result-row">
                <span class="result-label">Weight (tons/lbs):</span>
                <span id="weightResult">-</span>
              </div>
              <div class="result-row">
                <span class="result-label">Yield (lbs/sq yd):</span>
                <span id="yieldResult">-</span>
              </div>
            </div>

            <!-- 7. Add "Current Run" Summary -->
            <div class="run-summary-results">
              <h2>Current Run Summary</h2>
              <div class="result-row">
                <span class="result-label">Run Trucks:</span>
                <span id="runTotalTrucks">0</span>
              </div>
              <div class="result-row">
                <span class="result-label">Run Length (ft):</span>
                <span id="runTotalLength">0.00</span>
              </div>
              <div class="result-row">
                <span class="result-label">Run Area (sq yd):</span>
                <span id="runTotalArea">0.00</span>
              </div>
              <div class="result-row">
                <span class="result-label">Run Weight (tons/lbs):</span>
                <span id="runTotalWeight">0.00</span>
              </div>
              <div class="result-row">
                <span class="result-label">Run Avg Yield:</span>
                <span id="runAverageYield">0.00</span>
              </div>
            </div>

            <div class="day-summary-results"> <!-- Renamed class for clarity -->
              <!-- 6. Daily Yield Calculation (Day Summary) -->
              <h2>Day Summary (Calendar Day)</h2>
              <div class="result-row">
                <span class="result-label">Total Trucks:</span>
                <span id="dayTotalTrucks">0</span>
              </div>
              <div class="result-row">
                <span class="result-label">Total Length (ft):</span>
                <span id="dayTotalLength">0.00</span>
              </div>
              <div class="result-row">
                <span class="result-label">Total Area (sq yd):</span>
                <span id="dayTotalArea">0.00</span>
              </div>
              <div class="result-row">
                <span class="result-label">Total Weight (tons/lbs):</span>
                <span id="dayTotalWeight">0.00</span>
              </div>
              <div class="result-row">
                <span class="result-label">Average Yield:</span>
                <span id="dayAverageYield">0.00</span>
              </div>
            </div>

            <div class="button-group">
              <!-- 1. Rename "Start New Day" Button -->
              <button class="action-btn start-run-btn" id="startNewRunButton">
                Start New Run
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- End of Yield Calculator Tab -->

      <!-- ===== Data History Tab Content ===== -->
      <!-- 8. Update Title -->
      <div class="tab-content" id="dataTab">
        <h2>Today's Runs</h2>
        <div class="data-table-container">
          <table class="truck-data-table" id="truckDataTable">
            <thead>
              <tr>
                <th>Load #</th>
                <th>Start Sta.</th>
                <th>End Sta.</th>
                <th>Length (ft)</th>
                <th>Width (ft)</th>
                <th>Area (sq yd)</th>
                <th>Tonnage</th>
                <th>Weight (lbs)</th>
                <th>Yield (lbs/sq yd)</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="truckDataBody">
              <!-- Data appended via JavaScript -->
            </tbody>
            <tfoot id="truckDataFooter">
              <tr>
                <td>Run Totals:</td>
                <td>-</td>
                <td>-</td>
                <td id="runTotalLengthFoot">0.00</td>
                <td>-</td>
                <td id="runTotalAreaFoot">0.00</td>
                <td id="runTotalTonnageFoot">0.00</td>
                <td id="runTotalWeightFoot">0</td>
                <td id="runAvgYieldFoot">0.00</td>
                <td>-</td>
                <td>-</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Add edit controls for the table -->
        <div class="edit-controls">
          <button id="saveChangesBtn" class="action-btn save-btn">Save Changes</button>
          <button id="cancelEditingBtn" class="action-btn undo-btn">Cancel</button>
        </div>

        <!-- Archive Button -->
        <div style="margin-top: 15px; text-align: center; display: flex; justify-content: center; gap: 10px;">
          <!-- Add Edit Mode Toggle Button -->
          <button id="editModeBtn" class="action-btn btn-editable-mode" style="background-color: var(--primary); padding-top: 5px; padding-bottom: 5px;">
            Edit Table
          </button>
          <!-- 8. Rename button text -->
          <button id="viewArchivesButton" style="background-color: var(--secondary); padding-top: 5px; padding-bottom: 5px;" class="action-btn">Previous Days</button>
        </div>

        <!-- Archive Modal -->
        <div id="archiveModal">
          <div class="archive-modal-content">
            <span id="closeArchiveModal" class="archive-close">×</span>
            <h2>Previous Days' Run Data</h2>
            <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
              <select id="archiveDateSelect" style="flex-grow: 1; padding: 8px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px;">
                <option value="">Select a date...</option>
              </select>
            </div>
            <!-- Remove edit controls from here -->
            <!-- 9. Display Runs within Day -> Table container takes remaining space -->
            <div class="data-table-container" style="max-height: 65vh; text-align: center;">
              <!-- 11. Improve Mobile Display -> Styles applied via CSS -->
              <table class="truck-data-table" id="archiveDataTable" style="width: 80% !important; display: inline-block !important; margin: 0 auto !important;">
                <thead>
                  <tr>
                    <th>Load #</th>
                    <th>Start Sta.</th>
                    <th>End Sta.</th>
                    <th>Length (ft)</th>
                    <th>Width (ft)</th>
                    <th>Area (sq yd)</th>
                    <th>Tonnage</th>
                    <th>Weight (lbs)</th>
                    <th>Yield (lbs/sq yd)</th>
                    <th>Date</th>
                    <!-- 3. Add Remarks Feature: No column needed if shown in separator -->
                  </tr>
                </thead>
                <tbody id="archiveDataBody">
                  <!-- Archive data will be loaded here, including separators -->
                </tbody>
                <tfoot id="archiveDataFooter">
                  <tr>
                    <td>Day Totals:</td>
                    <td>-</td>
                    <td>-</td>
                    <td id="archiveTotalLength">0.00</td>
                    <td>-</td>
                    <td id="archiveTotalAreaFoot">0.00</td>
                    <td id="archiveTotalTonnageFoot">0.00</td>
                    <td id="archiveTotalWeightFoot">0</td>
                    <td id="archiveAvgYieldFoot">0.00</td>
                    <td>-</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <!-- Move buttons below the table -->
            <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
              <!-- Add Edit Mode Toggle Button for archive modal -->
              <button id="archiveEditModeBtn" class="action-btn btn-editable-mode" style="background-color: var(--primary);">
                Edit Table
              </button>
              <!-- 13. Rename Export button -->
              <button id="exportArchiveButton" class="action-btn save-btn">Export Day</button>
            </div>
            <!-- Add edit controls here, after the buttons -->
            <div class="edit-controls" id="archiveEditControls" style="margin-top: 10px;">
              <button id="saveArchiveChangesBtn" class="action-btn save-btn">Save Changes</button>
              <button id="cancelArchiveEditingBtn" class="action-btn undo-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
      <!-- End of Data History Tab -->

      <!-- Paver Speed Calculator Tab -->
      <div class="tab-content" id="paverSpeedTab">
        <h2>Paver Speed Calculator</h2>
        <div class="flex-container">
          <div class="input-section">
            <div class="input-grid">
              <div class="form-group">
                <label for="paverProdRate">Production Rate(R/p):</label>
                <input type="number" id="paverProdRate" step="0.01" min="0" placeholder="tons/hour" inputmode="decimal" />
              </div>
              <div class="form-group">
                <label for="paverWidth">Pavement Width (W):</label>
                <input type="number" id="paverWidth" step="0.01" min="0" placeholder="feet" inputmode="decimal" />
              </div>
              <div class="form-group">
                <label for="paverYield">Application Rate (A):</label>
                <input type="number" id="paverYield" step="0.01" min="0" placeholder="lbs/sq yd" inputmode="decimal" />
              </div>
            </div>
          </div>
        </div>
        <div class="results-container">
          <div class="current-results">
            <h3>Result</h3>
            <div class="result-row">
              <span class="result-label">Paver Speed:</span>
              <span><span id="paverSpeedResult">-</span> ft/min</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Projected Paving Length Calculator Tab -->
      <div class="tab-content" id="projLengthTab">
        <h2>Projected Paving Length Calculator</h2>
        <div class="flex-container">
          <div class="input-section">
            <div class="input-grid">
              <div class="form-group">
                <label for="projTons">Projected Daily Tons:</label>
                <input type="number" id="projTons" step="0.01" min="0" placeholder="tons" inputmode="decimal" />
              </div>
              <div class="form-group">
                <label for="projLaneWidth">Lane Width:</label>
                <input type="number" id="projLaneWidth" step="0.01" min="0" placeholder="feet" inputmode="decimal" />
              </div>
              <div class="form-group">
                <label for="projYield">Application Rate:</label>
                <input type="number" id="projYield" step="0.01" min="0" placeholder="lbs/sq yd" inputmode="decimal" />
              </div>
            </div>
          </div>
        </div>
        <div class="results-container">
          <div class="current-results">
            <h3>Result</h3>
            <div class="result-row">
              <span class="result-label">Projected Length:</span>
              <span><span id="projLengthResult">-</span> feet</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Tonnage (HMA Usage) Calculator Tab -->
      <div class="tab-content" id="tonnageTab">
        <h2>HMA Usage Calculator</h2>
        <div class="flex-container">
          <div class="input-section">
            <div class="input-grid">
              <div class="form-group">
                <label for="tonLength">Length:</label>
                <input type="number" id="tonLength" step="0.01" min="0" placeholder="feet" inputmode="decimal" />
              </div>
              <div class="form-group">
                <label for="tonWidth">Width:</label>
                <input type="number" id="tonWidth" step="0.01" min="0" placeholder="feet" inputmode="decimal" />
              </div>
              <div class="form-group">
                <label for="tonDepth">Depth:</label>
                <input type="number" id="tonDepth" step="0.01" min="0" placeholder="inches" inputmode="decimal" />
              </div>
            </div>
          </div>
        </div>
        <div class="results-container">
          <div class="current-results">
            <h3>Result</h3>
            <div class="result-row">
              <span class="result-label">Estimated Tonnage:</span>
              <span><span id="tonCalcResult">-</span> tons</span>
            </div>
          </div>
        </div>
      </div>
      <!-- End of Additional Tabs -->
    </div>
    <!-- End of Tab Container -->
  </div>

  <!-- About Modal -->
  <div id="aboutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
    <div class="archive-modal-content" style="max-height: 80vh; overflow-y: auto;">
      <span id="closeAboutModal" class="archive-close">×</span>
      <!-- 4. App Name Update -->
      <h2 style="color: var(--primary); margin-bottom: 15px;">About HMA Paving</h2>

      <div style="margin-bottom: 20px;">
        <h3 style="color: var(--secondary); margin-bottom: 10px;">Overview</h3>
        <p style="margin-bottom: 10px;">The HMA Paving app is a specialized tool designed for asphalt paving professionals to calculate and track material usage, paving speed, projected lengths, and tonnage requirements across different runs within a day.</p>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="color: var(--secondary); margin-bottom: 10px;">How to Use</h3>

        <h4 style="margin-top: 15px; margin-bottom: 5px;">Yield Calculator (Main Screen)</h4>
        <ol style="padding-left: 20px; margin-bottom: 10px;">
          <li>Enter Load Number, Tonnage, Start/End Stations, and Width for each truck.</li>
          <li>Length is calculated automatically.</li>
          <li>Click "Save Truck Data" to record the entry for the current run.</li>
          <li>Use the "Undo Last Save" button to remove the most recently saved truck entry.</li>
          <li>View immediate results in "Current Truck Results".</li>
          <li>View totals for the ongoing run in "Current Run Summary".</li>
          <li>View totals for the entire calendar day in "Day Summary".</li>
          <li>Click "Start New Run" when finishing a section or specific task. You'll be prompted for remarks for the completed run before the input fields clear for the next run. This archives the completed run's data.</li>
        </ol>

        <h4 style="margin-top: 15px; margin-bottom: 5px;">Current Run / History Tab</h4>
        <ul style="padding-left: 20px; margin-bottom: 10px;">
            <li>View all saved truck loads for the *current* run, with totals at the bottom.</li>
            <li>Click "View Archived Runs" to access data from completed runs and previous days.</li>
        </ul>

        <h4 style="margin-top: 15px; margin-bottom: 5px;">Archived Runs Viewer</h4>
        <ul style="padding-left: 20px; margin-bottom: 10px;">
            <li>Select a date from the dropdown to view all runs completed on that calendar day.</li>
            <li>Runs are separated visually, showing any remarks entered when "Start New Run" was clicked.</li>
            <li>Totals for the entire selected day are shown at the bottom.</li>
             <!-- 14. How to use the export feature -->
            <li>Click "Export Day (Excel)" to download an Excel (.xlsx) file containing all data for the selected date.</li>
        </ul>


        <h4 style="margin-top: 15px; margin-bottom: 5px;">Paver Speed Calculator</h4>
        <p style="margin-bottom: 10px;">Calculate optimal paver speed by entering Production Rate (tons/hour), Pavement Width (feet), and Application Rate (lbs/sq yd).</p>

        <h4 style="margin-top: 15px; margin-bottom: 5px;">Projected Length Calculator</h4>
        <p style="margin-bottom: 10px;">Determine projected paving length based on Projected Daily Tons, Lane Width, and Application Rate.</p>

        <h4 style="margin-top: 15px; margin-bottom: 5px;">Tonnage Calculator</h4>
        <!-- 5. About Section Text: Minor tweak -->
        <p style="margin-bottom: 10px;">Estimate the usage of Hot Mix Asphalt (HMA) needed based on Length, Width, and Depth measurements.</p>

        <h4 style="margin-top: 15px; margin-bottom: 5px;">Data Management</h4>
        <ul style="padding-left: 20px; margin-bottom: 10px;">
          <li>Clicking "Start New Run" archives the current run's data with optional remarks and resets the form.</li>
          <li>Data for the entire calendar day remains summarised in the "Day Summary" section.</li>
          <li>All data is stored locally on your device's browser storage. Clearing browser data will erase stored information.</li>
          <li>Night paving shifts crossing midnight: The app currently resets the "Day Summary" at midnight based on the device clock. Data is archived by calendar day.</li>
          <li>You can toggle the auto-fill feature in the side menu. When enabled, the previous end station automatically populates the next start station. When disabled, you'll need to manually enter start stations.</li>
        </ul>

         <!-- 14. Add Instructions: How to save the web app -->
        <h4 style="margin-top: 15px; margin-bottom: 5px;">Add to Home Screen (Install App)</h4>
        <p style="margin-bottom: 5px;">You can add this web app to your phone's home screen for easy access, like a native app:</p>
        <ul style="padding-left: 20px; margin-bottom: 10px;">
            <li><strong>iOS (Safari):</strong> Tap the Share button (square with arrow pointing up), then scroll down and tap "Add to Home Screen".</li>
            <li><strong>Android (Chrome):</strong> Tap the three-dot menu button, then tap "Install app" or "Add to Home screen".</li>
        </ul>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="color: var(--secondary); margin-bottom: 10px;">Author Information</h3>
        <p>Created by: Mark Heinonen</p>
        <p>Version: 1.2.2</p>
        <p>Contact: heinonenmh@gmail.com</p>
        <button id="reportBugButton" onclick="window.location.href='mailto:heinonenmh@gmail.com?subject=Bug Report: HMA Paving App'" style="background-color: var(--secondary); color: white; padding: 6px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Report a Bug</button>
      </div>

      <div style="text-align: center; margin-top: 20px;">
        <button id="closeAboutButton" style="background-color: var(--primary); color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer;">Close</button>
      </div>
    </div>
  </div>

  <script>
    /***********************************************************
     * Data and State
     ***********************************************************/
    // Data for the current run (since last 'Start New Run')
    let currentRunData = [];
    // Data for the entire current calendar day
    let calendarDayData = [];
    // State for undo functionality
    let lastAction = { type: null, data: null }; // type: 'add', 'delete'
    // Holds data loaded for display in archive modal
    let currentArchiveDisplayData = [];

    let lastEndValue = null;
    let lastWidth = null;
    let currentDate = getTodayDate(); // Current date in YYYY-MM-DD format

    // Constants
    const TONS_TO_POUNDS = 2000;
    const SQ_FT_TO_SQ_YD = 9;

    // Local Storage Keys
    const CURRENT_RUN_DATA_KEY = 'hmaPaving_currentRunData';
    const CALENDAR_DATA_PREFIX = 'hmaPaving_calendarData_';
    const ARCHIVES_KEY = 'hmaPaving_archives';
    const LAST_SAVED_DATE_KEY = 'hmaPaving_lastSavedDate';
    const LAST_END_VALUE_KEY = 'hmaPaving_lastEndValue';
    const LAST_WIDTH_KEY = 'hmaPaving_lastWidth';
    const THEME_KEY = 'hmaPaving_theme';
    const AUTO_FILL_KEY = 'hmaPaving_autoFill'; // Add new storage key


    /***********************************************************
     * DOM Elements
     ***********************************************************/
    // Date Display
    const currentDateDisplay = document.getElementById('currentDateDisplay');
    // Input Fields
    const truckNumberInput = document.getElementById('truckNumber');
    const truckTonnageInput = document.getElementById('truckTonnage');
    const startValueInput = document.getElementById('startValue');
    const endValueInput = document.getElementById('endValue');
    const widthInput = document.getElementById('width');
    const calculatedLengthInput = document.getElementById('calculatedLength');
    // Buttons
    const saveTruckButton = document.getElementById('saveTruckButton');
    const startNewRunButton = document.getElementById('startNewRunButton'); // Renamed ID
    const undoButton = document.getElementById('undoButton');
    // Current Truck Results Display
    const areaResult = document.getElementById('areaResult');
    const weightResult = document.getElementById('weightResult');
    const yieldResult = document.getElementById('yieldResult');
    const lengthResult = document.getElementById('lengthResult'); // NEW
    // Current Run Summary Display
    const runTotalTrucks = document.getElementById('runTotalTrucks');
    const runTotalArea = document.getElementById('runTotalArea');
    const runTotalWeight = document.getElementById('runTotalWeight');
    const runAverageYield = document.getElementById('runAverageYield');
    const runTotalLength = document.getElementById('runTotalLength'); // NEW
    // Day Summary Display
    const dayTotalTrucks = document.getElementById('dayTotalTrucks'); // Renamed ID
    const dayTotalArea = document.getElementById('dayTotalArea');     // Renamed ID
    const dayTotalWeight = document.getElementById('dayTotalWeight');   // Renamed ID
    const dayAverageYield = document.getElementById('dayAverageYield'); // Renamed ID
    const dayTotalLength = document.getElementById('dayTotalLength'); // NEW
    // Current Run Data Table (in Data History Tab)
    const truckDataBody = document.getElementById('truckDataBody');
    const runTotalLengthFoot = document.getElementById('runTotalLengthFoot'); // Renamed ID
    const runTotalAreaFoot = document.getElementById('runTotalAreaFoot');     // Renamed ID
    const runTotalTonnageFoot = document.getElementById('runTotalTonnageFoot'); // Renamed ID
    const runTotalWeightFoot = document.getElementById('runTotalWeightFoot');   // Renamed ID
    const runAvgYieldFoot = document.getElementById('runAvgYieldFoot');       // Renamed ID

    // Archive Modal Elements
    const viewArchivesButton = document.getElementById('viewArchivesButton');
    const archiveModal = document.getElementById('archiveModal');
    const closeArchiveModal = document.getElementById('closeArchiveModal');
    const archiveDateSelect = document.getElementById('archiveDateSelect');
    const archiveDataBody = document.getElementById('archiveDataBody');
    const archiveTotalLength = document.getElementById('archiveTotalLength');
    const archiveTotalAreaFoot = document.getElementById('archiveTotalAreaFoot');
    const archiveTotalTonnageFoot = document.getElementById('archiveTotalTonnageFoot');
    const archiveTotalWeightFoot = document.getElementById('archiveTotalWeightFoot');
    const archiveAvgYieldFoot = document.getElementById('archiveAvgYieldFoot');
    const exportArchiveButton = document.getElementById('exportArchiveButton'); // Renamed ID

    // About Modal Elements
    const aboutButton = document.getElementById('aboutButton');
    const aboutModal = document.getElementById('aboutModal');
    const closeAboutModal = document.getElementById('closeAboutModal');
    const closeAboutButton = document.getElementById('closeAboutButton');

    // Additional Calculators' DOM references
    const paverProdRate = document.getElementById('paverProdRate');
    const paverWidth = document.getElementById('paverWidth');
    const paverYield = document.getElementById('paverYield');
    const paverSpeedResult = document.getElementById('paverSpeedResult');
    const projTons = document.getElementById('projTons');
    const projLaneWidth = document.getElementById('projLaneWidth');
    const projYield = document.getElementById('projYield');
    const projLengthResult = document.getElementById('projLengthResult');
    const tonLength = document.getElementById('tonLength');
    const tonWidth = document.getElementById('tonWidth');
    const tonDepth = document.getElementById('tonDepth');
    const tonCalcResult = document.getElementById('tonCalcResult');

    // Hamburger Menu Elements
    const hamburgerIcon = document.querySelector('.hamburger-icon');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.overlay');
    const menuItems = document.querySelectorAll('.sidebar-menu li'); // Re-query after potential DOM changes
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeSwitch = document.getElementById('darkModeSwitch');
    const exportDataButton = document.getElementById('exportDataButton');

    // New variables for edit mode
    let isEditMode = false;
    let isArchiveEditMode = false;
    let originalCurrentRunData = [];
    let originalArchiveData = [];
    let editedCells = new Set();

    // Additional DOM elements for edit mode
    const editModeBtn = document.getElementById('editModeBtn');
    const archiveEditModeBtn = document.getElementById('archiveEditModeBtn');
    const saveChangesBtn = document.getElementById('saveChangesBtn');
    const cancelEditingBtn = document.getElementById('cancelEditingBtn');
    const saveArchiveChangesBtn = document.getElementById('saveArchiveChangesBtn');
    const cancelArchiveEditingBtn = document.getElementById('cancelArchiveEditingBtn');
    const archiveEditControls = document.getElementById('archiveEditControls');
    
    // New DOM elements for auto-fill toggle (within settings modal)
    // Note: These elements are now inside the settings modal, but IDs remain the same
    const autoFillToggle = document.getElementById('autoFillToggle');
    const autoFillSwitch = document.getElementById('autoFillSwitch');

    // Settings Modal Elements
    const settingsButton = document.getElementById('settingsButton');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const closeSettingsButton = document.getElementById('closeSettingsButton');

    // Auto-fill feature state
    let autoFillEnabled = true; // Default to enabled


    /***********************************************************
     * Initialization & Event Listeners
     ***********************************************************/
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent scrolling and zooming
        setupTouchControls();
        // Validate numeric inputs
        setupNumericInputValidation();
        // Load theme first
        initTheme();
        // Load data and set up UI
        initializeAppData();
        // Setup event listeners
        setupEventListeners();
        // Initial UI update
        updateAllUI();
    });

    function initializeAppData() {
        checkDateChangeAndLoadData(); // Handles loading based on date change
        updateDateDisplay();
        // Load auto-fill setting
        initAutoFill();
        // Initial calculation/state check
        updateLength();
        calculateYield();
    }

    function setupEventListeners() {
        // Input listeners for real-time calculation
        [startValueInput, endValueInput, widthInput, truckTonnageInput].forEach(el => {
            el.addEventListener('input', () => {
                updateLength();
                calculateYield();
            });
        });
        truckNumberInput.addEventListener('input', checkSaveButtonState);

        // Button listeners
        saveTruckButton.addEventListener('click', saveTruckData);
        startNewRunButton.addEventListener('click', startNewRun); // Use renamed button/function
        undoButton.addEventListener('click', undoLastAction);

        // Archive listeners
        viewArchivesButton.addEventListener('click', openArchiveModal);
        closeArchiveModal.addEventListener('click', closeArchiveModalFunc);
        archiveDateSelect.addEventListener('change', loadArchiveDataForSelectedDate); // Renamed handler
        exportArchiveButton.addEventListener('click', exportArchiveToExcel); // Use renamed function

        // About modal listeners
        aboutButton.addEventListener('click', openAboutModal);
        closeAboutModal.addEventListener('click', closeAboutModalFunc);
        closeAboutButton.addEventListener('click', closeAboutModalFunc);
        
        // Export data button listener
        exportDataButton.addEventListener('click', exportTodayDataToExcel);

        // Modal closing on background click
        window.addEventListener('click', function(event) {
            if (event.target == archiveModal) closeArchiveModalFunc();
            if (event.target == aboutModal) closeAboutModalFunc();
            if (event.target == settingsModal) closeSettingsModalFunc(); // Close settings modal on overlay click
        });
        document.querySelector('#archiveModal > .archive-modal-content').addEventListener('click', e => e.stopPropagation());
        document.querySelector('#aboutModal > .archive-modal-content').addEventListener('click', e => e.stopPropagation());
        document.querySelector('#settingsModal > .archive-modal-content').addEventListener('click', e => e.stopPropagation()); // Prevent closing settings modal when clicking inside content


        // Additional Calculator listeners
        [paverProdRate, paverWidth, paverYield].forEach(el => el.addEventListener('input', calculatePaverSpeed));
        [projTons, projLaneWidth, projYield].forEach(el => el.addEventListener('input', calculateProjectedLength));
        [tonLength, tonWidth, tonDepth].forEach(el => el.addEventListener('input', calculateTonnageUsed));

        // Hamburger/Sidebar listeners
        setupSidebarMenu();

        // Save data on page unload
        window.addEventListener('beforeunload', saveData); // Simple save, archiving handled by date check/startNewRun

        // Edit mode buttons listeners
        editModeBtn.addEventListener('click', toggleEditMode);
        archiveEditModeBtn.addEventListener('click', toggleArchiveEditMode);
        saveChangesBtn.addEventListener('click', saveCurrentRunEdits);
        cancelEditingBtn.addEventListener('click', cancelCurrentRunEdits);
        saveArchiveChangesBtn.addEventListener('click', saveArchiveEdits);
        cancelArchiveEditingBtn.addEventListener('click', cancelArchiveEdits);
    }

    function updateAllUI() {
        updateDateDisplay();
        updateCurrentRunTable(); // Renamed from updateTruckTable
        updateCurrentRunSummary(); // New function for run summary box
        updateDaySummary(); // Renamed from updateTotals
        updateCurrentRunTableFooter(); // Renamed from updateFooterTotals
        checkSaveButtonState();
        checkUndoButtonState();
    }

    /***********************************************************
     * Date & Data Loading / Saving / Archiving
     ***********************************************************/

    // Get today's date in YYYY-MM-DD format using local time zone
    function getTodayDate() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Format date for display (e.g., "Wed, Sep 25, 2024")
    function formatDateForDisplay(dateString) {
        try {
            // Handles YYYY-MM-DD format correctly regardless of timezone issues with Date constructor
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day); // Month is 0-indexed
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        } catch (e) {
            console.error("Error formatting date:", dateString, e);
            return dateString; // Fallback
        }
    }

    // Update the date display in the header
    function updateDateDisplay() {
      currentDateDisplay.textContent = formatDateForDisplay(currentDate);
    }

    // Check if the calendar date has changed, handle archiving, and load data
    function checkDateChangeAndLoadData() {
        const todayDate = getTodayDate();
        const savedDate = localStorage.getItem(LAST_SAVED_DATE_KEY);

        // Determine the date to operate on
        currentDate = savedDate || todayDate; // Use saved date if available, otherwise today

        if (savedDate && savedDate !== todayDate) {
            // Archive data from the 'savedDate' if it exists
            const prevCalendarData = loadDataFromStorage(CALENDAR_DATA_PREFIX + savedDate);
            const prevRunData = loadDataFromStorage(CURRENT_RUN_DATA_KEY); // Assumes this belongs to savedDate

            // Archive the last run data of the previous day if not empty
            if (prevRunData && prevRunData.length > 0) {
                archiveRunData(savedDate, prevRunData, "Auto-archived due to date change");
            }

            // Clear data for the new day
            calendarDayData = [];
            currentRunData = [];
            lastEndValue = null; // Reset carry-over values for a new day
            lastWidth = null;
            localStorage.removeItem(LAST_END_VALUE_KEY);
            localStorage.removeItem(LAST_WIDTH_KEY);
            currentDate = todayDate; // Set current date to today
        } else {
            // Load data for the current date
            calendarDayData = loadDataFromStorage(CALENDAR_DATA_PREFIX + currentDate) || [];
            currentRunData = loadDataFromStorage(CURRENT_RUN_DATA_KEY) || []; // Load potentially ongoing run
            lastEndValue = parseFloat(localStorage.getItem(LAST_END_VALUE_KEY)) || null;
            lastWidth = parseFloat(localStorage.getItem(LAST_WIDTH_KEY)) || null;

            // Restore input fields if applicable, respecting auto-fill setting
            if (autoFillEnabled && lastEndValue !== null) {
                startValueInput.value = lastEndValue.toFixed(2);
            }
            if (lastWidth !== null) widthInput.value = lastWidth.toFixed(2);
        }

        // Always save the current date as the last saved date
        localStorage.setItem(LAST_SAVED_DATE_KEY, currentDate);
        updateDateDisplay(); // Ensure display matches loaded/current date
    }

    // Helper to load and parse JSON from localStorage
    function loadDataFromStorage(key) {
        const data = localStorage.getItem(key);
        if (data) {
            try {
                return JSON.parse(data);
            } catch (err) {
                localStorage.removeItem(key); // Remove corrupted data
                return null;
            }
        }
        return null;
    }

    // Save all relevant data to localStorage
    function saveData() {
        try {
            localStorage.setItem(CURRENT_RUN_DATA_KEY, JSON.stringify(currentRunData));
            localStorage.setItem(CALENDAR_DATA_PREFIX + currentDate, JSON.stringify(calendarDayData));
            localStorage.setItem(LAST_SAVED_DATE_KEY, currentDate);
            if (lastEndValue !== null) localStorage.setItem(LAST_END_VALUE_KEY, lastEndValue.toString());
            else localStorage.removeItem(LAST_END_VALUE_KEY);
            if (lastWidth !== null) localStorage.setItem(LAST_WIDTH_KEY, lastWidth.toString());
            else localStorage.removeItem(LAST_WIDTH_KEY);
        } catch (error) {
            console.error("Error saving data to localStorage:", error);
            alert("Error saving data. Local storage might be full or unavailable.");
        }
    }

     // Archives the provided run data under the specified date
    function archiveRunData(date, runData, remarks) {
        if (!runData || runData.length === 0) {
            return;
        }
        try {
            let archives = loadDataFromStorage(ARCHIVES_KEY) || {};
            if (!archives[date]) {
                archives[date] = [];
            }

            const runArchive = {
                runId: new Date().toISOString(), // Unique ID for the run
                data: runData,
                remarks: remarks || "N/A" // Ensure remarks are always present
            };

            archives[date].push(runArchive);
            localStorage.setItem(ARCHIVES_KEY, JSON.stringify(archives));
        } catch (error) {
            console.error("Error archiving run data:", error);
        }
    }


    // Action triggered by "Start New Run" button
    function startNewRun() {
      // "Start New Run" Action: Prompt for Remarks (Mandatory)
      let remarks = "";
      if (currentRunData.length > 0) { // Only prompt if there's data to archive
          remarks = prompt(`Enter remarks for the run just completed (Load ${currentRunData[0]?.loadNumber || '?'} to ${currentRunData[currentRunData.length-1]?.loadNumber || '?'}). Enter "N/A" if none.`);
          while (!remarks) { // Loop until non-empty input is provided
              alert("Remarks are mandatory. Please enter remarks or 'N/A'.");
              remarks = prompt(`Enter remarks for the run just completed (Load ${currentRunData[0]?.loadNumber || '?'} to ${currentRunData[currentRunData.length-1]?.loadNumber || '?'}). Enter "N/A" if none.`);
          }
           // Archive the current run data with remarks
          archiveRunData(currentDate, [...currentRunData], remarks); // Pass a copy
      } else {
          console.log("Start New Run clicked, but no data in the current run to archive.");
          if (!confirm("Current run is empty. Start a new run anyway (clears form)?")) {
              return; // User cancelled
          }
      }


      // "Start New Run" Action: Clear current run data and reset form
      currentRunData = [];
      lastEndValue = null; // Clear carry-over values for a new run *within the same day*
      lastWidth = null;
      resetFormForNextTruck();

      // Update UI
      updateAllUI(); // Update tables, summaries, etc.

      // Save the cleared state
      saveData();

      // Clear last action for undo
      lastAction = { type: null, data: null };
      checkUndoButtonState();

      console.log("New run started on", currentDate);
    }

    /***********************************************************
     * Core Yield Calculator Functions
     ***********************************************************/
    function updateLength() {
      const startValue = parseFloat(startValueInput.value);
      const endValue = parseFloat(endValueInput.value);
      // Check if both values are valid numbers (not NaN), allowing zero
      calculatedLengthInput.value = (!isNaN(startValue) && !isNaN(endValue) && endValue >= 0) ? Math.abs(endValue - startValue).toFixed(2) : '';
    }

    function calculateYield() {
      const length = parseFloat(calculatedLengthInput.value) || 0;
      const width = parseFloat(widthInput.value) || 0;
      const tonnage = parseFloat(truckTonnageInput.value) || 0;

      if (length <= 0 || width <= 0 || tonnage <= 0) {
        lengthResult.textContent = '-'; // NEW
        areaResult.textContent = '-';
        weightResult.textContent = '-';
        yieldResult.textContent = '-';
        checkSaveButtonState(); // Disable save if yield is invalid
        return;
      }

      const areaInSqFt = length * width;
      const areaInSqYd = areaInSqFt / SQ_FT_TO_SQ_YD;
      const weightInPounds = tonnage * TONS_TO_POUNDS;
      const yieldVal = areaInSqYd > 0 ? (weightInPounds / areaInSqYd) : 0;

      lengthResult.textContent = length.toFixed(2); // NEW
      areaResult.textContent = areaInSqYd.toFixed(2);
      weightResult.textContent = `${tonnage.toFixed(2)} / ${weightInPounds.toLocaleString()} lbs`;
      yieldResult.textContent = yieldVal.toFixed(2);

      checkSaveButtonState(); // Check if save can be enabled
    }

    function checkSaveButtonState() {
        const hasLoadNumber = truckNumberInput.value.trim() !== '';
        const hasValidYield = yieldResult.textContent !== '-' && parseFloat(yieldResult.textContent) > 0;
        saveTruckButton.disabled = !(hasLoadNumber && hasValidYield);
    }


    function saveTruckData() {
      if (saveTruckButton.disabled) return; // Prevent saving if button is disabled

      saveTruckButton.disabled = true;
      saveTruckButton.innerHTML = 'Saving... <div class="loader"></div>';

      const loadNumber = truckNumberInput.value.trim();
      const startVal = parseFloat(startValueInput.value);
      const endVal = parseFloat(endValueInput.value);
      const lengthVal = parseFloat(calculatedLengthInput.value) || 0;
      const widthVal = parseFloat(widthInput.value) || 0;
      const areaVal = parseFloat(areaResult.textContent) || 0;
      const tonnageVal = parseFloat(truckTonnageInput.value) || 0;
      const weightVal = parseFloat(weightResult.textContent) || 0; // This is now in tons
      const yieldVal = parseFloat(yieldResult.textContent) || 0;

      const truckData = {
        id: Date.now().toString(), // Unique ID for the entry
        loadNumber,
        startValue: isNaN(startVal) ? 0 : startVal, // Handle NaN explicitly
        endValue: isNaN(endVal) ? 0 : endVal, // Handle NaN explicitly
        length: lengthVal,
        width: widthVal,
        area: areaVal,
        tonnage: tonnageVal,
        weight: tonnageVal, // Use tonnage directly for weight
        yield: yieldVal,
        date: currentDate // Use current app date
      };

      // Add to both current run and calendar day data
      currentRunData.push(truckData);
      calendarDayData.push(truckData);

      // Update last values for auto-population
      lastEndValue = endVal;
      lastWidth = widthVal;

      // Set last action for undo
      lastAction = { type: 'add', data: { ...truckData } }; // Store a copy

      // Save data, update UI, reset form
      saveData();
      updateAllUI();
      resetFormForNextTruck();

      saveTruckButton.innerHTML = 'Save Truck Data'; // Restore button text
      truckNumberInput.focus();
    }

    function resetFormForNextTruck() {
      truckNumberInput.value = '';
      truckTonnageInput.value = '';
      
      // Only auto-fill start value if the feature is enabled
      if (autoFillEnabled && lastEndValue !== null) {
          startValueInput.value = lastEndValue.toFixed(2);
      } else {
          startValueInput.value = '';
      }
      
      endValueInput.value = '';
      // Only auto-fill width if it wasn't manually cleared
      if (lastWidth !== null && widthInput.value === '') {
          widthInput.value = lastWidth.toFixed(2);
      } else if (lastWidth !== null && widthInput.value !== lastWidth.toFixed(2)) {
          // If user changed width manually, don't overwrite, but clear lastWidth carryover
          lastWidth = null;
          localStorage.removeItem(LAST_WIDTH_KEY);
      }
      calculatedLengthInput.value = '';
      areaResult.textContent = '-';
      weightResult.textContent = '-';
      yieldResult.textContent = '-';
      checkSaveButtonState(); // Should disable save button
      updateLength(); // Recalculate length based on new start value
      calculateYield(); // Recalculate yield based on cleared fields
    }

    function deleteEntry(id) {
        const runIndex = currentRunData.findIndex(t => t.id === id);
        const dayIndex = calendarDayData.findIndex(t => t.id === id);
        
        // Check if the entry exists in any archived run for today
        let archives = loadDataFromStorage(ARCHIVES_KEY) || {};
        let runsForToday = archives[currentDate] || [];
        let archivedRunIndex = -1;
        let archivedTruckIndex = -1;
        
        // Look through today's archives for the entry
        for (let i = 0; i < runsForToday.length; i++) {
            const run = runsForToday[i];
            if (run.data && Array.isArray(run.data)) {
                const truckIndex = run.data.findIndex(t => t.id === id);
                if (truckIndex !== -1) {
                    archivedRunIndex = i;
                    archivedTruckIndex = truckIndex;
                    break;
                }
            }
        }

        // Determine which record to delete
        let truckToDelete = null;
        if (runIndex !== -1) {
            truckToDelete = currentRunData[runIndex];
        } else if (dayIndex !== -1) {
            truckToDelete = calendarDayData[dayIndex];
        } else if (archivedRunIndex !== -1 && archivedTruckIndex !== -1) {
            truckToDelete = runsForToday[archivedRunIndex].data[archivedTruckIndex];
        }

        if (!truckToDelete) return; // Not found in any dataset

        if (confirm(`Delete entry for Load ${truckToDelete?.loadNumber || id}? This cannot be undone in the same way as 'Undo Last Save'.`)) {
             // Set last action for potential (more complex) undo, different from simple 'add' undo
            lastAction = { type: 'delete', data: { ...truckToDelete } };

            // Remove from current run data if found there
            if (runIndex !== -1) {
                currentRunData.splice(runIndex, 1);
            }
            
            // Remove from calendar day data if found there
            if (dayIndex !== -1) {
                calendarDayData.splice(dayIndex, 1);
            }
            
            // Remove from archives if found there
            if (archivedRunIndex !== -1 && archivedTruckIndex !== -1) {
                runsForToday[archivedRunIndex].data.splice(archivedTruckIndex, 1);
                
                // If the run is now empty, consider removing it entirely
                if (runsForToday[archivedRunIndex].data.length === 0) {
                    runsForToday.splice(archivedRunIndex, 1);
                }
                
                // Update the archives in localStorage
                archives[currentDate] = runsForToday;
                localStorage.setItem(ARCHIVES_KEY, JSON.stringify(archives));
            }

            saveData();
            updateAllUI();
             // Disable simple undo after a delete action
             undoButton.disabled = true;
        }
    }

    // 15. Undo Last Action (Simple Undo for last saved truck)
    function undoLastAction() {
        if (lastAction.type === 'add' && lastAction.data) {
            const lastAddedId = lastAction.data.id;

            // Remove from currentRunData
            const runIndex = currentRunData.findIndex(t => t.id === lastAddedId);
            if (runIndex > -1) {
                currentRunData.splice(runIndex, 1);
            }

            // Remove from calendarDayData
            const dayIndex = calendarDayData.findIndex(t => t.id === lastAddedId);
            if (dayIndex > -1) {
                calendarDayData.splice(dayIndex, 1);
            }

            // Clear the last action so it can't be undone again
            lastAction = { type: null, data: null };

            // Update UI and save state
            saveData();
            updateAllUI(); // This includes checkUndoButtonState

            alert("Last saved truck entry removed.");

            // Potentially restore previous 'lastEndValue' and 'lastWidth'? More complex.
            // For simplicity, just remove the entry.

        } else {
            alert("No save action to undo.");
        }
    }

     function checkUndoButtonState() {
        undoButton.disabled = !(lastAction.type === 'add' && lastAction.data);
    }


    /***********************************************************
     * UI Update Functions (Summaries & Tables)
     ***********************************************************/

    // Update the table showing the loads for the CURRENT DAY (all runs)
    function updateCurrentRunTable() {
      truckDataBody.innerHTML = ''; // Clear current run table body

      // Get archives for today
      const archives = loadDataFromStorage(ARCHIVES_KEY) || {};
      const runsForToday = archives[currentDate] || [];
      
      // Sort runs by their runId (timestamp)
      runsForToday.sort((a, b) => a.runId.localeCompare(b.runId));
      
      // Display archived runs from today first
      runsForToday.forEach((run, index) => {
        // Add separator for each run
        const separatorRow = document.createElement('tr');
        separatorRow.className = 'run-separator';
        separatorRow.setAttribute('data-run-id', run.runId); // Add run ID for edit mode
        const runTime = new Date(run.runId).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        separatorRow.innerHTML = `<td colspan="11">Run ended at: ${runTime}<span>Remarks: ${run.remarks || 'N/A'}</span></td>`;
        truckDataBody.appendChild(separatorRow);
        
        // Add truck data for this run
        if (run.data && Array.isArray(run.data)) {
          run.data.forEach(truck => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${truck.loadNumber || ''}</td>
              <td>${(truck.startValue ?? 0).toFixed(2)}</td>
              <td>${(truck.endValue ?? 0).toFixed(2)}</td>
              <td>${(truck.length ?? 0).toFixed(2)}</td>
              <td>${(truck.width ?? 0).toFixed(2)}</td>
              <td>${(truck.area ?? 0).toFixed(2)}</td>
              <td>${(truck.tonnage ?? 0).toFixed(2)}</td>
              <td>${((truck.tonnage ?? 0) * 2000).toLocaleString()}</td>
              <td>${(truck.yield ?? 0).toFixed(2)}</td>
              <td>${formatDateForDisplay(truck.date) || ''}</td>
              <td><span class="delete-btn" data-id="${truck.id}">✖</span></td>
            `;
            truckDataBody.appendChild(row);
          });
        }
      });
      
      // Then display current run data (if it exists)
      if (currentRunData.length > 0) {
        // Add separator for current run
        const currentRunHeader = document.createElement('tr');
        currentRunHeader.className = 'run-separator';
        currentRunHeader.innerHTML = `<td colspan="10">Current Run (In Progress)<span>Remarks: In progress</span></td>`;
        truckDataBody.appendChild(currentRunHeader);
        
        // Add current run data
        currentRunData.forEach(truck => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${truck.loadNumber || ''}</td>
            <td>${(truck.startValue ?? 0).toFixed(2)}</td>
            <td>${(truck.endValue ?? 0).toFixed(2)}</td>
            <td>${(truck.length ?? 0).toFixed(2)}</td>
            <td>${(truck.width ?? 0).toFixed(2)}</td>
            <td>${(truck.area ?? 0).toFixed(2)}</td>
            <td>${(truck.tonnage ?? 0).toFixed(2)}</td>
            <td>${((truck.tonnage ?? 0) * 2000).toLocaleString()}</td>
            <td>${(truck.yield ?? 0).toFixed(2)}</td>
            <td>${formatDateForDisplay(truck.date) || ''}</td>
            <td><span class="delete-btn" data-id="${truck.id}">✖</span></td>
          `;
          truckDataBody.appendChild(row);
        });
      }
      
      // Show message if no data for today
      if (runsForToday.length === 0 && currentRunData.length === 0) {
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = '<td colspan="10" style="text-align: center; font-style: italic;">No runs for today yet</td>';
        truckDataBody.appendChild(noDataRow);
      }

      // Re-attach delete handlers (only for current run items)
      document.querySelectorAll('#truckDataBody .delete-btn').forEach(btn => {
         // Remove existing listener before adding a new one to prevent duplicates
         btn.replaceWith(btn.cloneNode(true));
         truckDataBody.querySelector(`[data-id="${btn.getAttribute('data-id')}"]`).addEventListener('click', (e) => {
             const id = e.target.getAttribute('data-id');
             if (id) deleteEntry(id);
         });
      });

      // Update the footer for the table (show day totals)
      updateCurrentRunTableFooter();
    }

    // Update the footer totals for the table (showing day totals)
    function updateCurrentRunTableFooter() {
      // Use day totals (all data for today)
      const totals = calculateTotals(calendarDayData);
      runTotalLengthFoot.textContent = totals.totalLength.toFixed(2);
      runTotalAreaFoot.textContent = totals.totalArea.toFixed(2);
      runTotalTonnageFoot.textContent = totals.totalTonnage.toFixed(2);
      runTotalWeightFoot.textContent = (totals.totalWeight * TONS_TO_POUNDS).toLocaleString();
      runAvgYieldFoot.textContent = totals.avgYield.toFixed(2);
    }

    // Update the "Current Run Summary" box
    function updateCurrentRunSummary() {
        const totals = calculateTotals(currentRunData);
        runTotalTrucks.textContent = totals.count;
        runTotalLength.textContent = totals.totalLength.toFixed(2); // NEW
        runTotalArea.textContent = totals.totalArea.toFixed(2);
        runTotalWeight.textContent = `${totals.totalWeight.toFixed(2)} / ${(totals.totalWeight * TONS_TO_POUNDS).toLocaleString()} lbs`;
        runAverageYield.textContent = totals.avgYield.toFixed(2);
    }

    // Update the "Day Summary" box (using calendar day data)
    function updateDaySummary() {
        const totals = calculateTotals(calendarDayData);
        dayTotalTrucks.textContent = totals.count;
        dayTotalLength.textContent = totals.totalLength.toFixed(2); // NEW
        dayTotalArea.textContent = totals.totalArea.toFixed(2);
        dayTotalWeight.textContent = `${totals.totalWeight.toFixed(2)} / ${(totals.totalWeight * TONS_TO_POUNDS).toLocaleString()} lbs`;
        dayAverageYield.textContent = totals.avgYield.toFixed(2);
    }


    // Helper function to calculate totals for any given array of truck data
    function calculateTotals(dataArray) {
      const count = dataArray.length;
      const totalLength = dataArray.reduce((sum, t) => sum + (t.length || 0), 0);
      const totalArea = dataArray.reduce((sum, t) => sum + (t.area || 0), 0);
      const totalTonnage = dataArray.reduce((sum, t) => sum + (t.tonnage || 0), 0);
      const totalWeight = dataArray.reduce((sum, t) => sum + (t.tonnage || 0), 0); // Use tonnage for weight consistently
      const avgYield = (totalArea > 0) ? ((totalWeight * TONS_TO_POUNDS) / totalArea) : 0; // Convert tons to pounds for yield calc
      return { count, totalLength, totalArea, totalTonnage, totalWeight, avgYield };
    }


    /***********************************************************
     * Archive Viewing Functions
     ***********************************************************/

    function openArchiveModal() {
      populateArchiveDates(); // Populate dropdown with unique dates (previous days)
      archiveModal.style.display = 'block';
      
      // Clear previous data and set default view
      archiveDataBody.innerHTML = ''; 
      const noSelectionRow = document.createElement('tr');
      noSelectionRow.innerHTML = '<td colspan="9" style="text-align: center; font-style: italic;">Select a date to view previous runs</td>';
      archiveDataBody.appendChild(noSelectionRow);
      
      // Reset totals - pass an empty array
      updateArchiveFooterTotals([]);
      
      // Set the title to indicate these are previous days' runs
      document.querySelector('#archiveModal h2').textContent = "Previous Days' Run Data";
    }

    // Function to display today's runs in the archive view - REMOVED

    function closeArchiveModalFunc() {
      archiveModal.style.display = 'none';
    }

    // 9. Display Runs within Day: Populate dropdown with unique dates only
    function populateArchiveDates() {
      archiveDateSelect.innerHTML = '<option value="">Select a date...</option>'; // Clear existing options

      const archives = loadDataFromStorage(ARCHIVES_KEY) || {};
      const todayDate = getTodayDate(); // Get current date
      
      // Filter out today's date and get unique dates
      const uniqueDates = [...new Set(Object.keys(archives))]
                           .filter(date => date !== todayDate) // Filter out today
                           .sort((a, b) => new Date(b) - new Date(a)); // Sort descending

      uniqueDates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = formatDateForDisplay(date); // Display formatted date
        archiveDateSelect.appendChild(option);
      });
      
      // Display message if no previous dates
      if (uniqueDates.length === 0) {
        const noDataOption = document.createElement('option');
        noDataOption.disabled = true;
        noDataOption.textContent = "No previous days' data available";
        archiveDateSelect.appendChild(noDataOption);
      }
    }


     // 9. Display Runs within Day: Load all runs for the selected calendar date
    function loadArchiveDataForSelectedDate() {
        const selectedDate = archiveDateSelect.value;
        archiveDataBody.innerHTML = ''; // Clear previous data
        currentArchiveDisplayData = []; // Clear data holder

        if (!selectedDate) {
            // If no date is selected, show message
            const noSelectionRow = document.createElement('tr');
            noSelectionRow.innerHTML = '<td colspan="9" style="text-align: center; font-style: italic;">Select a date to view previous runs</td>';
            archiveDataBody.appendChild(noSelectionRow);
            // Reset totals
            updateArchiveFooterTotals([]);
            return;
        }

        // Set the title to indicate we're viewing a previous day
        document.querySelector('#archiveModal h2').textContent = `Run Data for ${formatDateForDisplay(selectedDate)}`;

        const archives = loadDataFromStorage(ARCHIVES_KEY) || {};
        const runsForDay = archives[selectedDate] || [];

        // Sort runs by their runId (timestamp)
        runsForDay.sort((a, b) => a.runId.localeCompare(b.runId));

        let allDataForDay = []; // To calculate totals

        runsForDay.forEach((run, index) => {
            // 10. Visual Separators
            if (index > 0) { // Add separator before the second run onwards
                const separatorRow = document.createElement('tr');
                separatorRow.className = 'run-separator';
                separatorRow.setAttribute('data-run-id', run.runId); // Add run ID for edit mode
                const runTime = new Date(run.runId).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                separatorRow.innerHTML = `<td colspan="9">Run ended at: ${runTime} <span>Remarks: ${run.remarks || 'N/A'}</span></td>`;
                archiveDataBody.appendChild(separatorRow);
            } else {
                 // Optional: Add header for the first run
                 const separatorRow = document.createElement('tr');
                 separatorRow.className = 'run-separator';
                 separatorRow.setAttribute('data-run-id', run.runId); // Add run ID for edit mode
                 const runTime = new Date(run.runId).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                 separatorRow.innerHTML = `<td colspan="9">Run ended at: ${runTime} (First run of day)<span>Remarks: ${run.remarks || 'N/A'}</span></td>`;
                 archiveDataBody.appendChild(separatorRow);
            }

            // Add truck data rows for this run
            if (run.data && Array.isArray(run.data)) {
                run.data.forEach(truck => {
                    // Ensure each record has an ID
                    if (!truck.id) {
                        truck.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    const row = document.createElement('tr');
                    row.setAttribute('data-record-id', truck.id);
                    row.innerHTML = `
                        <td>${truck.loadNumber || ''}</td>
                        <td>${(truck.startValue ?? 0).toFixed(2)}</td>
                        <td>${(truck.endValue ?? 0).toFixed(2)}</td>
                        <td>${(truck.length ?? 0).toFixed(2)}</td>
                        <td>${(truck.width ?? 0).toFixed(2)}</td>
                        <td>${(truck.area ?? 0).toFixed(2)}</td>
                        <td>${(truck.tonnage ?? 0).toFixed(2)}</td>
                        <td>${((truck.tonnage ?? 0) * 2000).toLocaleString()}</td>
                        <td>${(truck.yield ?? 0).toFixed(2)}</td>
                        <td>${formatDateForDisplay(truck.date) || ''}</td>
                    `;
                    archiveDataBody.appendChild(row);
                    allDataForDay.push(truck); // Add to array for total calculation and export
                });
            }
        });

        // If no data for selected day, show a message
        if (allDataForDay.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = '<td colspan="9" style="text-align: center; font-style: italic;">No data found for selected date</td>';
            archiveDataBody.appendChild(noDataRow);
        }

        currentArchiveDisplayData = allDataForDay; // Store for export
        updateArchiveFooterTotals(allDataForDay); // Update footer with totals for all runs of the day
    }

    // Update the footer totals for the ARCHIVE table
    function updateArchiveFooterTotals(data) {
      // Ensure data is an array before passing to calculateTotals
      const dataArray = Array.isArray(data) ? data : [];
      const totals = calculateTotals(dataArray); // Use the common calculator
      archiveTotalLength.textContent = totals.totalLength.toFixed(2);
      archiveTotalAreaFoot.textContent = totals.totalArea.toFixed(2);
      archiveTotalTonnageFoot.textContent = totals.totalTonnage.toFixed(2);
      archiveTotalWeightFoot.textContent = totals.totalWeight.toFixed(2);
      archiveAvgYieldFoot.textContent = totals.avgYield.toFixed(2);
    }


    /***********************************************************
     * Export Functionality (Excel)
     ***********************************************************/

     // 13. Export selected day's data (all runs) to Excel
    function exportArchiveToExcel() {
        const selectedDate = archiveDateSelect.value;
        const todayDate = getTodayDate();
        let exportDate = selectedDate || todayDate; // If no date is selected, use today
        let exportTitle = selectedDate ? `HMA_Paving_${exportDate}` : `HMA_Paving_Today_${exportDate}`;

        if (currentArchiveDisplayData.length === 0) {
            alert('No data available to export.');
            return;
        }

        console.log(`Exporting ${currentArchiveDisplayData.length} records for ${exportDate} to Excel...`);

        // Prepare data for SheetJS: Array of objects
        const dataForSheet = currentArchiveDisplayData.map(item => ({
            'Date': formatDateForDisplay(item.date) || '',
            'Load Number': item.loadNumber || '',
            'Start Sta.': (item.startValue ?? 0).toFixed(2),
            'End Sta.': (item.endValue ?? 0).toFixed(2),
            'Length (ft)': (item.length ?? 0).toFixed(2),
            'Width (ft)': (item.width ?? 0).toFixed(2),
            'Area (sq yd)': (item.area ?? 0).toFixed(2),
            'Tonnage (tons)': (item.tonnage ?? 0).toFixed(2),
            'Weight (lbs)': ((item.tonnage ?? 0) * 2000).toLocaleString(),
            'Yield (lbs/sq yd)': (item.yield ?? 0).toFixed(2)
            // Remarks could be added as a column if desired, but they are in separators visually
        }));

        // Add a totals row at the end
        const totals = calculateTotals(currentArchiveDisplayData);
        dataForSheet.push({ // Add an empty row for spacing
             'Date': '', 'Load Number': '', 'Start Sta.': '', 'End Sta.': '', 'Length (ft)': '',
             'Width (ft)': '', 'Area (sq yd)': '', 'Tonnage (tons)': '', 'Weight (lbs)': '', 'Yield (lbs/sq yd)': ''
        });
        dataForSheet.push({
            'Date': 'TOTALS',
            'Load Number': '',
            'Start Sta.': '',
            'End Sta.': '',
            'Length (ft)': totals.totalLength.toFixed(2),
            'Width (ft)': '',
            'Area (sq yd)': totals.totalArea.toFixed(2),
            'Tonnage (tons)': totals.totalTonnage.toFixed(2),
            'Weight (lbs)': (totals.totalWeight * 2000).toLocaleString(),
            'Yield (lbs/sq yd)': totals.avgYield.toFixed(2)
        });

        try {
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(dataForSheet);

            // Optional: Adjust column widths
             const columnWidths = [
                { wch: 15 }, // Date
                { wch: 12 }, // Load Number
                { wch: 12 }, // Start Sta.
                { wch: 12 }, // End Sta.
                { wch: 12 }, // Length (ft)
                { wch: 12 }, // Width (ft)
                { wch: 13 }, // Area (sq yd)
                { wch: 14 }, // Tonnage (tons)
                { wch: 18 },  // Weight (lbs)
                { wch: 18 }  // Yield (lbs/sq yd)
            ];
            worksheet['!cols'] = columnWidths;


            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Yield Data');

            // Generate filename
            const filename = exportDate === todayDate ? 
                `HMA_Paving_Today_${exportDate}.xlsx` : 
                `HMA_Paving_Previous_Day_${exportDate}.xlsx`;

            // Trigger download
            XLSX.writeFile(workbook, filename);
            console.log("Excel file generation successful.");

        } catch (error) {
            console.error("Error generating Excel file:", error);
            alert("Failed to generate Excel file. See console for details.");
        }
    }

    // Function to export today's data directly without opening the archive modal
    function exportTodayDataToExcel() {
        const todayDate = getTodayDate();
        const archives = loadDataFromStorage(ARCHIVES_KEY) || {};
        
        // Get all available dates (including today)
        const availableDates = [...new Set([...Object.keys(archives), todayDate])].sort((a, b) => new Date(b) - new Date(a));
        
        // Create and show date selection modal
        const modalHtml = `
        <div id="exportDateModal" style="display: block; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: var(--card-bg); margin: 15% auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; width: 80%; max-width: 400px; color: var(--text-color);">
                <h3 style="margin-top: 0; text-align: center;">Select Date to Export</h3>
                <select id="exportDateSelect" style="width: 100%; padding: 8px; margin-bottom: 15px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px;">
                    ${availableDates.map(date => `<option value="${date}">${date} (${formatDateForDisplay(date)})</option>`).join('')}
                </select>
                <div style="display: flex; justify-content: space-between; gap: 30px;">
                    <button id="cancelExportDate" style="padding: 8px 16px; background-color: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer; min-width: 100px;">Cancel</button>
                    <button id="confirmExportDate" style="padding: 8px 16px; background-color: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; min-width: 100px;">Export</button>
                </div>
            </div>
        </div>
        `;
        
        // Add modal to the body
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);
        
        // Setup event listeners for the modal
        document.getElementById('cancelExportDate').addEventListener('click', function() {
            document.body.removeChild(modalContainer);
        });
        
        document.getElementById('confirmExportDate').addEventListener('click', function() {
            const dateToExport = document.getElementById('exportDateSelect').value;
            document.body.removeChild(modalContainer);
            
            // Continue with export process
            exportDataForDate(dateToExport);
        });
        
        // Close modal when clicking outside
        document.getElementById('exportDateModal').addEventListener('click', function(event) {
            if (event.target === document.getElementById('exportDateModal')) {
                document.body.removeChild(modalContainer);
            }
        });
    }
    
    // New function to handle the actual export after date selection
    function exportDataForDate(dateToExport) {
        const todayDate = getTodayDate();
        const archives = loadDataFromStorage(ARCHIVES_KEY) || {};
        
        // Get data for the specified date
        let dataToExport = [];
        
        // If exporting today's date, include current run data
        if (dateToExport === todayDate) {
            dataToExport = [...currentRunData];
            
            // Add calendar day data
            if (calendarDayData && Array.isArray(calendarDayData) && calendarDayData.length > 0) {
                dataToExport = [...dataToExport, ...calendarDayData];
            }
        }
        
        // Add archived data for the selected date
        if (archives[dateToExport]) {
            archives[dateToExport].forEach(run => {
                if (run.data && Array.isArray(run.data)) {
                    dataToExport = [...dataToExport, ...run.data];
                }
            });
        }
        
        // Remove duplicates by load number if present
        if (dataToExport.length > 0 && dataToExport[0].loadNumber) {
            const uniqueData = [];
            const loadNumbers = new Set();
            
            dataToExport.forEach(item => {
                if (item.loadNumber && !loadNumbers.has(item.loadNumber)) {
                    loadNumbers.add(item.loadNumber);
                    uniqueData.push(item);
                } else if (!item.loadNumber) {
                    // If no load number, just include it
                    uniqueData.push(item);
                }
            });
            
            dataToExport = uniqueData;
        }
        
        // Check if we have data to export
        if (dataToExport.length === 0) {
            alert(`No data available to export for ${dateToExport}.`);
            return;
        }
        
        console.log(`Exporting ${dataToExport.length} records for ${dateToExport} to Excel...`);
        
        // Prepare data for SheetJS: Array of objects
        const dataForSheet = dataToExport.map(item => ({
            'Date': formatDateForDisplay(item.date) || '',
            'Load Number': item.loadNumber || '',
            'Start Sta.': (item.startValue ?? 0).toFixed(2),
            'End Sta.': (item.endValue ?? 0).toFixed(2),
            'Length (ft)': (item.length ?? 0).toFixed(2),
            'Width (ft)': (item.width ?? 0).toFixed(2),
            'Area (sq yd)': (item.area ?? 0).toFixed(2),
            'Tonnage (tons)': (item.tonnage ?? 0).toFixed(2),
            'Weight (lbs)': ((item.tonnage ?? 0) * 2000).toLocaleString(),
            'Yield (lbs/sq yd)': (item.yield ?? 0).toFixed(2)
        }));
        
        // Add a totals row at the end
        const totals = calculateTotals(dataToExport);
        dataForSheet.push({ // Add an empty row for spacing
             'Date': '', 'Load Number': '', 'Start Sta.': '', 'End Sta.': '', 'Length (ft)': '',
             'Width (ft)': '', 'Area (sq yd)': '', 'Tonnage (tons)': '', 'Weight (lbs)': '', 'Yield (lbs/sq yd)': ''
        });
        dataForSheet.push({
            'Date': 'TOTALS',
            'Load Number': '',
            'Start Sta.': '',
            'End Sta.': '',
            'Length (ft)': totals.totalLength.toFixed(2),
            'Width (ft)': '',
            'Area (sq yd)': totals.totalArea.toFixed(2),
            'Tonnage (tons)': totals.totalTonnage.toFixed(2),
            'Weight (lbs)': (totals.totalWeight * 2000).toLocaleString(),
            'Yield (lbs/sq yd)': totals.avgYield.toFixed(2)
        });
        
        try {
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(dataForSheet);
            
            // Optional: Adjust column widths
            const columnWidths = [
                { wch: 15 }, // Date
                { wch: 12 }, // Load Number
                { wch: 12 }, // Start Sta.
                { wch: 12 }, // End Sta.
                { wch: 12 }, // Length (ft)
                { wch: 12 }, // Width (ft)
                { wch: 13 }, // Area (sq yd)
                { wch: 14 }, // Tonnage (tons)
                { wch: 18 },  // Weight (lbs)
                { wch: 18 }  // Yield (lbs/sq yd)
            ];
            worksheet['!cols'] = columnWidths;
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Yield Data');
            
            // Generate filename
            const filename = dateToExport === todayDate ? 
                `HMA_Paving_Today_${dateToExport}.xlsx` : 
                `HMA_Paving_${dateToExport}.xlsx`;
            
            // Trigger download
            XLSX.writeFile(workbook, filename);
            console.log("Excel file generation successful.");
            
        } catch (error) {
            console.error("Error generating Excel file:", error);
            alert("Failed to generate Excel file. See console for details.");
        }
    }


    /***********************************************************
     * Additional Calculators (No data storage)
     ***********************************************************/
    function calculatePaverSpeed() { /* ... (implementation unchanged) ... */
      const R_p = parseFloat(paverProdRate.value) || 0;
      const W = parseFloat(paverWidth.value) || 0;
      const A = parseFloat(paverYield.value) || 0;
      if (R_p <= 0 || W <= 0 || A <= 0 || A === Infinity) {
        paverSpeedResult.textContent = '-'; return;
      }
      const L = (2000 * 9) / (W * A);
      const V = (R_p * L) / 60;
      paverSpeedResult.textContent = (V === Infinity || isNaN(V)) ? '-' : V.toFixed(2);
    }
    function calculateProjectedLength() { /* ... (implementation unchanged) ... */
      const T = parseFloat(projTons.value) || 0;
      const LW = parseFloat(projLaneWidth.value) || 0;
      const Y = parseFloat(projYield.value) || 0;
      if (T <= 0 || LW <= 0 || Y <= 0) {
        projLengthResult.textContent = '-'; return;
      }
      const denominator = (((LW * 100) / 9) * Y) / 2000;
      if (denominator <= 0 || denominator === Infinity || isNaN(denominator)) {
          projLengthResult.textContent = '-'; return;
      }
      const projLength = (T / denominator) * 100;
      projLengthResult.textContent = (projLength === Infinity || isNaN(projLength)) ? '-' : projLength.toFixed(2);
    }
    function calculateTonnageUsed() { /* ... (implementation unchanged) ... */
      const L = parseFloat(tonLength.value) || 0;
      const W = parseFloat(tonWidth.value) || 0;
      const D = parseFloat(tonDepth.value) || 0;
      if (L <= 0 || W <= 0 || D <= 0) {
        tonCalcResult.textContent = '-'; return;
      }
      const areaYd2 = (L * W) / 9;
      const lbs = areaYd2 * 110 * D; // Using standard 110 lb/sq yd/in rule of thumb
      const tonsUsed = lbs / 2000;
      tonCalcResult.textContent = tonsUsed.toFixed(2);
    }

    /***********************************************************
     * Sidebar, Theme, PWA, Misc Utils
     ***********************************************************/

    function initTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY);
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            darkModeSwitch.classList.add('active');
        } else {
            document.documentElement.removeAttribute('data-theme');
            darkModeSwitch.classList.remove('active');
        }
    }

     function toggleDarkMode() {
        if (document.documentElement.getAttribute('data-theme') === 'dark') {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem(THEME_KEY, 'light');
            darkModeSwitch.classList.remove('active');
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem(THEME_KEY, 'dark');
            darkModeSwitch.classList.add('active');
        }
    }

    function setupSidebarMenu() {
        // Re-select menu items in case of dynamic changes (though unlikely here)
        const currentMenuItems = document.querySelectorAll('.sidebar-menu li');

        hamburgerIcon.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', closeMenu);

        // Dark mode toggle listener
        darkModeToggle.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent li click handler
            toggleDarkMode();
        });
        darkModeSwitch.addEventListener('click', (e) => {
             e.stopPropagation(); // Prevent li click handler
            toggleDarkMode();
        });

        // Auto-fill toggle listener
        autoFillToggle.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent li click handler
            toggleAutoFill();
        });
        autoFillSwitch.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent li click handler
            toggleAutoFill();
        });


        currentMenuItems.forEach(item => {
            if (item.id === 'darkModeToggle') return; // Skip dark mode item

            if (item.id === 'aboutButton') {
                 // Special handler for About button
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openAboutModal();
                    closeMenu(); // Close sidebar after action
                });
            } else if (item.id === 'settingsButton') {
                // Special handler for Settings button
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openSettingsModal();
                    closeMenu(); // Close sidebar after action
                });
            } else if (item.getAttribute('data-tab')) {
                // Standard tab navigation handler
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tabId = this.getAttribute('data-tab');

                    // Update active class in sidebar
                    currentMenuItems.forEach(mi => mi.classList.remove('active'));
                    this.classList.add('active');

                    // Update tab content visibility
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    const targetTab = document.getElementById(tabId);
                    if(targetTab) targetTab.classList.add('active');

                    closeMenu(); // Close sidebar after navigation
                });
            }
        });
    }


    function toggleMenu() {
      hamburgerIcon.classList.toggle('open');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }
    function closeMenu() {
      hamburgerIcon.classList.remove('open');
      sidebar.classList.remove('open');
      overlay.classList.remove('open');
    }
    function openAboutModal() {
      aboutModal.style.display = 'block';
      closeMenu();
    }
    function closeAboutModalFunc() {
      aboutModal.style.display = 'none';
    }

    // Settings Modal Functions
    function openSettingsModal() {
        settingsModal.style.display = 'block';
        closeMenu(); // Ensure sidebar is closed when modal opens
    }
    function closeSettingsModalFunc() {
        settingsModal.style.display = 'none';
    }

    function setupTouchControls() {
         document.addEventListener('touchmove', function(event) {
            // Allow vertical scrolling within designated containers
            const canScroll = event.target.closest('.container, .data-table-container, .archive-modal-content, .sidebar');
            if (!canScroll && event.touches.length === 1) {
                 // Prevent scroll only if not in a scrollable area and it's a single touch
                 // This helps prevent body scroll while allowing pinch zoom if needed
                // event.preventDefault(); // Commented out to be less aggressive, rely on CSS fixed body
            }
             // Prevent pinch zoom explicitly (more reliable)
            if (event.scale !== undefined && event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });
    }

    function setupNumericInputValidation() {
        const numericInputs = document.querySelectorAll('input[type="number"]');
        numericInputs.forEach(input => {
             input.addEventListener('input', function() {
                // Optional: Add more aggressive validation on input if needed
                const value = this.value;
                // Remove non-numeric characters except decimal point and leading minus (if allowed)
                // This example doesn't allow minus, enforces positive numbers or zero
                 let cleanedValue = value.replace(/[^\d.]/g, '');
                 // Ensure only one decimal point
                 const parts = cleanedValue.split('.');
                 if (parts.length > 2) {
                     cleanedValue = parts[0] + '.' + parts.slice(1).join('');
                 }
                 if (cleanedValue !== value) {
                     this.value = cleanedValue;
                 }
             });

            input.addEventListener('blur', function() {
                if (this.value !== '') {
                    const min = parseFloat(this.min);
                    const value = parseFloat(this.value);
                    if (!isNaN(min) && !isNaN(value) && value < min) {
                        this.value = min.toFixed(this.step.includes('.') ? this.step.split('.')[1].length : 0); // Format to correct decimal places
                    }
                     // Ensure non-empty fields aren't just "."
                    if (this.value === '.') {
                        this.value = '';
                    }
                }
            });
        });
    }

    // Service Worker Registration (Optional but good for PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js') // Make sure sw.js exists
          .then(registration => console.log('Service Worker registered successfully:', registration.scope))
          .catch(error => console.error('Service Worker registration failed:', error));
      });
    }

    // Add collapsible functionality for the truck information card
    document.addEventListener('DOMContentLoaded', function() {
      const truckInfoHeader = document.getElementById('truckInfoHeader');
      const truckInfoContent = document.getElementById('truckInfoContent');
      const collapseIcon = truckInfoHeader.querySelector('.collapse-icon');
      
      truckInfoHeader.addEventListener('click', function() {
        truckInfoContent.classList.toggle('collapsed');
        collapseIcon.classList.toggle('collapsed');
      });
    });

    // Function to toggle edit mode for current run data
    function toggleEditMode() {
        if (isEditMode) {
            // Exit edit mode without saving
            cancelCurrentRunEdits();
            return;
        }

        // Enable edit mode
        isEditMode = true;
        editModeBtn.textContent = 'Disable Edit Mode';
        editModeBtn.style.backgroundColor = 'var(--danger)';
        
        // Hide the 'Previous Days' button while in edit mode
        viewArchivesButton.style.display = 'none';
        
        // Store original data for potential cancel
        originalCurrentRunData = JSON.parse(JSON.stringify(currentRunData));
        
        // Apply editable class to container
        document.getElementById('dataTab').classList.add('editable-mode-active');
        
        // Make table cells editable
        makeCurrentRunTableEditable();
    }

    // Function to toggle edit mode for archive data
    function toggleArchiveEditMode() {
        if (isArchiveEditMode) {
            // Exit edit mode without saving
            cancelArchiveEdits();
            return;
        }

        const selectedDate = archiveDateSelect.value;
        if (!selectedDate) {
            alert('Please select a date first before enabling edit mode.');
            return;
        }

        // Enable edit mode
        isArchiveEditMode = true;
        archiveEditModeBtn.textContent = 'Disable Edit Mode';
        archiveEditModeBtn.style.backgroundColor = 'var(--danger)';
        archiveEditControls.style.display = 'flex'; // Show controls

        // Hide export button while in edit mode
        exportArchiveButton.style.display = 'none';

        // Store original data for potential cancel
        originalArchiveData = JSON.parse(JSON.stringify(currentArchiveDisplayData));

        // Apply editable class to container
        document.querySelector('.archive-modal-content').classList.add('editable-mode-active');

        // Make table cells editable
        makeArchiveTableEditable();
    }

    // Make the current run table cells editable
    function makeCurrentRunTableEditable() {
        const rows = truckDataBody.querySelectorAll('tr');
        rows.forEach(row => {
            // Make run separator remarks editable
            if (row.classList.contains('run-separator')) {
                const remarksSpan = row.querySelector('span');
                if (remarksSpan) {
                    // Get only the remarks text without the label
                    const remarksText = remarksSpan.textContent.replace('Remarks: ', '');
                    
                    // Store the original text and replace with editable version
                    remarksSpan.dataset.originalValue = remarksText;
                    remarksSpan.innerHTML = `Remarks: <span contenteditable="true" class="editable-remarks" data-run-id="${row.getAttribute('data-run-id')}">${remarksText}</span>`;
                    
                    // Add event listeners
                    const editableSpan = remarksSpan.querySelector('.editable-remarks');
                    editableSpan.addEventListener('input', function() {
                        if (this.textContent !== this.parentNode.dataset.originalValue) {
                            this.classList.add('cell-edited');
                            editedCells.add(this);
                        } else {
                            this.classList.remove('cell-edited');
                            editedCells.delete(this);
                        }
                    });
                }
                return;
            }
            
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) {
                // Make specific cells editable (load number, start/end value, width, tonnage)
                for (let i = 0; i < cells.length; i++) {
                    // Make only certain cells editable (exclude calculated fields)
                    if (i === 0 || i === 1 || i === 2 || i === 4 || i === 6) {
                        cells[i].setAttribute('contenteditable', 'true');
                        cells[i].dataset.originalValue = cells[i].textContent.trim();
                        cells[i].dataset.columnIndex = i;
                        cells[i].dataset.rowIndex = Array.from(rows).indexOf(row);
                        cells[i].addEventListener('input', handleCellEdit);
                        cells[i].addEventListener('blur', validateCellEdit);
                    } else if (i !== cells.length - 1) { // Exclude action column
                        cells[i].classList.add('non-editable');
                    }
                }
            }
        });
    }

    // Make the archive table cells editable
    function makeArchiveTableEditable() {
        const rows = archiveDataBody.querySelectorAll('tr');
        let dataIndex = 0;
        
        rows.forEach(row => {
            // Make run separator remarks editable
            if (row.classList.contains('run-separator')) {
                const remarksSpan = row.querySelector('span');
                if (remarksSpan) {
                    // Get only the remarks text without the label
                    const remarksText = remarksSpan.textContent.replace('Remarks: ', '');
                    
                    // Get the run ID from the row if available
                    const runId = row.getAttribute('data-run-id');
                    
                    // Store the original text and replace with editable version
                    remarksSpan.dataset.originalValue = remarksText;
                    remarksSpan.innerHTML = `Remarks: <span contenteditable="true" class="editable-remarks" data-run-id="${runId}">${remarksText}</span>`;
                    
                    // Add event listeners
                    const editableSpan = remarksSpan.querySelector('.editable-remarks');
                    editableSpan.addEventListener('input', function() {
                        if (this.textContent !== this.parentNode.dataset.originalValue) {
                            this.classList.add('cell-edited');
                            editedCells.add(this);
                        } else {
                            this.classList.remove('cell-edited');
                            editedCells.delete(this);
                        }
                    });
                }
                return;
            }
            
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) {
                // Get data ID for this row (if we have it in currentArchiveDisplayData)
                const dataId = dataIndex < currentArchiveDisplayData.length ? 
                    currentArchiveDisplayData[dataIndex].id : null;
                
                // Store data-id on the row for tracking purposes
                if (dataId) {
                    row.setAttribute('data-record-id', dataId);
                }
                
                // Make specific cells editable (load number, start/end value, width, tonnage)
                for (let i = 0; i < cells.length; i++) {
                    // Make only certain cells editable (exclude calculated fields)
                    if (i === 0 || i === 1 || i === 2 || i === 4 || i === 6) {
                        cells[i].setAttribute('contenteditable', 'true');
                        cells[i].dataset.originalValue = cells[i].textContent.trim();
                        cells[i].dataset.columnIndex = i;
                        cells[i].dataset.rowIndex = dataIndex; // Use data index, not visual row index
                        cells[i].dataset.recordId = dataId; // Store the data ID for mapping
                        cells[i].addEventListener('input', handleArchiveCellEdit);
                        cells[i].addEventListener('blur', validateArchiveCellEdit);
                    } else {
                        cells[i].classList.add('non-editable');
                    }
                }
                
                // Increment data index for the next data row
                dataIndex++;
            }
        });
    }

    // Handle cell edit in current run table
    function handleCellEdit(e) {
        const cell = e.target;
        
        // Add visual indicator that cell has been edited
        const originalValue = cell.dataset.originalValue;
        if (cell.textContent.trim() !== originalValue) {
            cell.classList.add('cell-edited');
            editedCells.add(cell);
        } else {
            cell.classList.remove('cell-edited');
            editedCells.delete(cell);
        }
        
        // If editing is done in the current run (not archived runs), recalculate immediately
        if (!cell.closest('#archiveDataBody')) {
            const rowIndex = parseInt(cell.dataset.rowIndex);
            recalculateRowValues(rowIndex, cell.closest('tr'), 'current');
        }
    }

    // Handle cell edit in archive table
    function handleArchiveCellEdit(e) {
        const cell = e.target;
        
        // Add visual indicator that cell has been edited
        const originalValue = cell.dataset.originalValue;
        if (cell.textContent.trim() !== originalValue) {
            cell.classList.add('cell-edited');
            editedCells.add(cell);
        } else {
            cell.classList.remove('cell-edited');
            editedCells.delete(cell);
        }
        
        // Recalculate values for this row
        const rowIndex = parseInt(cell.dataset.rowIndex);
        const recordId = cell.dataset.recordId;
        recalculateRowValues(rowIndex, cell.closest('tr'), 'archive', recordId);
    }

    // Validate cell edit (ensure it's a number for numeric cells)
    function validateCellEdit(e) {
        const cell = e.target;
        const columnIndex = parseInt(cell.dataset.columnIndex);
        
        // Skip validation for load number (column 0)
        if (columnIndex === 0) return;
        
        // For numeric columns, ensure content is a valid number
        let value = cell.textContent.trim();
        if (value === '') {
            value = '0';
        }
        
        if (isNaN(parseFloat(value))) {
            // Invalid number, revert to original
            cell.textContent = cell.dataset.originalValue;
            cell.classList.remove('cell-edited');
            editedCells.delete(cell);
            alert('Please enter a valid number.');
        } else {
            // Valid number, format it nicely
            const formattedValue = parseFloat(value).toFixed(2);
            cell.textContent = formattedValue;
            
            // Check if value has actually changed after formatting
            if (formattedValue === cell.dataset.originalValue) {
                cell.classList.remove('cell-edited');
                editedCells.delete(cell);
            }
        }
    }

    // Same validation for archive cells
    function validateArchiveCellEdit(e) {
        validateCellEdit(e); // Reuse the same validation logic
    }

    // Recalculate row values based on edited cells
    function recalculateRowValues(rowIndex, row, tableType, recordId) {
        if (!row) return;
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 9) return;
        
        // Get input values from editable cells
        const startValue = parseFloat(cells[1].textContent) || 0;
        const endValue = parseFloat(cells[2].textContent) || 0;
        const width = parseFloat(cells[4].textContent) || 0;
        const tonnage = parseFloat(cells[6].textContent) || 0;
        
        // Calculate new values
        const length = Math.abs(endValue - startValue);
        const areaInSqFt = length * width;
        const areaInSqYd = areaInSqFt / SQ_FT_TO_SQ_YD;
        const weightInPounds = tonnage * TONS_TO_POUNDS;
        const yieldVal = areaInSqYd > 0 ? (weightInPounds / areaInSqYd) : 0;
        
        // Update the calculated cells
        cells[3].textContent = length.toFixed(2); // Length
        cells[5].textContent = areaInSqYd.toFixed(2); // Area
        cells[6].textContent = tonnage.toFixed(2); // This should display the tonnage input value
        cells[7].textContent = yieldVal.toFixed(2); // Yield
        
        // Update the data object
        if (tableType === 'current') {
            // Find which dataset this row belongs to (current run or archived run from today)
            let datasetIndex = -1;
            let dataItem = null;
            
            // First check if it's in current run data
            const currentRunIndex = currentRunData.findIndex(
                item => item.id === row.querySelector('.delete-btn')?.getAttribute('data-id')
            );
            
            if (currentRunIndex !== -1) {
                datasetIndex = currentRunIndex;
                dataItem = currentRunData[datasetIndex];
            } else {
                // Check if it's in calendar day data
                const calendarDayIndex = calendarDayData.findIndex(
                    item => item.id === row.querySelector('.delete-btn')?.getAttribute('data-id')
                );
                
                if (calendarDayIndex !== -1) {
                    datasetIndex = calendarDayIndex;
                    dataItem = calendarDayData[datasetIndex];
                }
            }
            
            if (dataItem) {
                // Update the data object with new values
                dataItem.startValue = startValue;
                dataItem.endValue = endValue;
                dataItem.length = length;
                dataItem.width = width;
                dataItem.area = areaInSqYd;
                dataItem.tonnage = tonnage;
                dataItem.weight = tonnage;
                dataItem.yield = yieldVal;
                
                // Update summaries and footer totals
                updateCurrentRunSummary();
                updateDaySummary();
                updateCurrentRunTableFooter();
            }
        } else if (tableType === 'archive') {
            // For archive tables, use recordId or fallback to rowIndex
            let dataItem;
            
            if (recordId) {
                // Find the item by ID (more reliable)
                dataItem = currentArchiveDisplayData.find(item => item.id === recordId);
            } else if (rowIndex >= 0 && rowIndex < currentArchiveDisplayData.length) {
                // Fallback to index-based lookup
                dataItem = currentArchiveDisplayData[rowIndex];
            }
            
            if (dataItem) {
                // Update the data object with new values
                dataItem.startValue = startValue;
                dataItem.endValue = endValue;
                dataItem.length = length;
                dataItem.width = width;
                dataItem.area = areaInSqYd;
                dataItem.tonnage = tonnage;
                dataItem.weight = tonnage;
                dataItem.yield = yieldVal;
                
                // Update archive table footer totals
                updateArchiveFooterTotals(currentArchiveDisplayData);
            }
        }
    }

    // Save edits to current run data
    function saveCurrentRunEdits() {
        if (editedCells.size === 0) {
            alert('No changes to save.');
            return;
        }
        
        if (confirm('Save all edits to current day data?')) {
            // Process remarks edits for archived runs
            const archives = loadDataFromStorage(ARCHIVES_KEY) || {};
            const runsForToday = archives[currentDate] || [];
            let hasRemarksChanges = false;
            
            // Check for edited remarks
            const editedRemarks = truckDataBody.querySelectorAll('.editable-remarks.cell-edited');
            editedRemarks.forEach(remarksElem => {
                const runId = remarksElem.getAttribute('data-run-id');
                if (runId) {
                    // Find the run with this ID
                    const runIndex = runsForToday.findIndex(run => run.runId === runId);
                    if (runIndex !== -1) {
                        // Update the remarks
                        runsForToday[runIndex].remarks = remarksElem.textContent.trim();
                        hasRemarksChanges = true;
                    }
                }
            });
            
            // If we have remarks changes, save the archives
            if (hasRemarksChanges) {
                archives[currentDate] = runsForToday;
                localStorage.setItem(ARCHIVES_KEY, JSON.stringify(archives));
            }
            
            // Save to localStorage (for truck data edits)
            saveData();
            
            // Reset edit mode
            isEditMode = false;
            editModeBtn.textContent = 'Enable Edit Mode';
            editModeBtn.style.backgroundColor = 'var(--primary)';
            document.getElementById('dataTab').classList.remove('editable-mode-active');
            
            // Remove editable attributes
            removeEditableAttributes(truckDataBody);
            
            // Clear edited cells tracker
            editedCells.clear();
            
            // Show the 'Previous Days' button again
            viewArchivesButton.style.display = 'block';
            
            // Refresh the UI to show updated remarks
            updateCurrentRunTable();
            
            // Alert success
            alert('Changes saved successfully.');
        }
    }

    // Cancel edits to current run data
    function cancelCurrentRunEdits() {
        if (editedCells.size > 0) {
            if (!confirm('Discard all unsaved changes?')) {
                return;
            }
        }
        
        // Restore original data
        currentRunData = JSON.parse(JSON.stringify(originalCurrentRunData));
        
        // Reset edit mode
        isEditMode = false;
        editModeBtn.textContent = 'Enable Edit Mode';
        editModeBtn.style.backgroundColor = 'var(--primary)';
        document.getElementById('dataTab').classList.remove('editable-mode-active');
        
        // Remove editable attributes
        removeEditableAttributes(truckDataBody);
        
        // Clear edited cells tracker
        editedCells.clear();
        
        // Show the 'Previous Days' button again
        viewArchivesButton.style.display = 'block';
        
        // Refresh the UI
        updateCurrentRunTable();
        updateCurrentRunSummary();
        updateDaySummary();
    }

    // Save edits to archive data
    function saveArchiveEdits() {
        if (editedCells.size === 0) {
            alert('No changes to save.');
            return;
        }
        
        const selectedDate = archiveDateSelect.value;
        if (!selectedDate) {
            alert('Cannot save: No date selected.');
            return;
        }
        
        if (confirm('Save all edits to archived data?')) {
            // Get current archives
            let archives = loadDataFromStorage(ARCHIVES_KEY) || {};
            let runsForDay = archives[selectedDate] || [];
            
            // Sort runs by their runId (timestamp)
            runsForDay.sort((a, b) => a.runId.localeCompare(b.runId));
            
            // Create a map of original IDs to edited data
            const editedDataMap = {};
            currentArchiveDisplayData.forEach(item => {
                if (item && item.id) {
                    editedDataMap[item.id] = { ...item };
                }
            });
            
            // Check for edited remarks
            const editedRemarks = archiveDataBody.querySelectorAll('.editable-remarks.cell-edited');
            editedRemarks.forEach(remarksElem => {
                const runId = remarksElem.getAttribute('data-run-id');
                if (runId) {
                    // Find the run with this ID
                    const runIndex = runsForDay.findIndex(run => run.runId === runId);
                    if (runIndex !== -1) {
                        // Update the remarks
                        runsForDay[runIndex].remarks = remarksElem.textContent.trim();
                    }
                }
            });
            
            // Apply edits to each run based on matching IDs
            let anyChanges = false;
            runsForDay.forEach(run => {
                if (run.data && Array.isArray(run.data)) {
                    run.data.forEach((item, index) => {
                        if (item.id && editedDataMap[item.id]) {
                            // Replace the original data with edited data
                            run.data[index] = editedDataMap[item.id];
                            anyChanges = true;
                        }
                    });
                }
            });
            
            if (!anyChanges && editedRemarks.length === 0) {
                console.warn("No changes were mapped to archive structure. This shouldn't happen.");
            }
            
            // Save updated archives
            archives[selectedDate] = runsForDay;
            localStorage.setItem(ARCHIVES_KEY, JSON.stringify(archives));
            
            // Reset edit mode
            isArchiveEditMode = false;
            archiveEditModeBtn.textContent = 'Enable Edit Mode';
            archiveEditModeBtn.style.backgroundColor = 'var(--primary)';
            document.querySelector('.archive-modal-content').classList.remove('editable-mode-active');
            
            // Remove editable attributes
            removeEditableAttributes(archiveDataBody);
            
            // Clear edited cells tracker
            editedCells.clear();
            
            // Show export button again
            exportArchiveButton.style.display = 'block';
            
            // Alert success
            alert('Changes to archived data saved successfully.');
        }
    }

    // Cancel edits to archive data
    function cancelArchiveEdits() {
        if (editedCells.size > 0) {
            if (!confirm('Discard all unsaved changes?')) {
                return;
            }
        }
        
        // Restore original data
        currentArchiveDisplayData = JSON.parse(JSON.stringify(originalArchiveData));
        
        // Reset edit mode
        isArchiveEditMode = false;
        archiveEditModeBtn.textContent = 'Enable Edit Mode';
        archiveEditModeBtn.style.backgroundColor = 'var(--primary)';
        archiveEditControls.style.display = 'none'; // Hide controls
        document.querySelector('.archive-modal-content').classList.remove('editable-mode-active');
        
        // Remove editable attributes
        removeEditableAttributes(archiveDataBody);
        
        // Clear edited cells tracker
        editedCells.clear();
        
        // Show export button again
        exportArchiveButton.style.display = 'block';
        
        // Refresh the UI - reload the selected date
        loadArchiveDataForSelectedDate();
    }

    // Remove editable attributes from cells
    function removeEditableAttributes(tableBody) {
        // Remove contenteditable from cells
        const cells = tableBody.querySelectorAll('td[contenteditable="true"]');
        cells.forEach(cell => {
            cell.removeAttribute('contenteditable');
            cell.classList.remove('cell-edited');
            
            // Remove event listeners (tricky, so recreate the element)
            const newCell = cell.cloneNode(true);
            cell.parentNode.replaceChild(newCell, cell);
        });
        
        // Handle editable remarks specifically
        const editableRemarks = tableBody.querySelectorAll('.editable-remarks');
        editableRemarks.forEach(remarksElem => {
            const parentSpan = remarksElem.parentNode;
            if (parentSpan) {
                // Replace with simple text
                parentSpan.textContent = 'Remarks: ' + remarksElem.textContent;
            }
        });
    }

    // Add to closeArchiveModalFunc - ensure edit mode is reset
    function closeArchiveModalFunc() {
      if (isArchiveEditMode) {
        cancelArchiveEdits(); // This will also hide the controls
      } else {
         archiveEditControls.style.display = 'none'; // Ensure controls are hidden even if not in edit mode
      }
      archiveModal.style.display = 'none';
    }

    // Initialize auto-fill setting
    function initAutoFill() {
        const savedAutoFill = localStorage.getItem(AUTO_FILL_KEY);
        if (savedAutoFill === 'false') {
            autoFillEnabled = false;
            autoFillSwitch.classList.remove('active');
        } else {
            autoFillEnabled = true;
            autoFillSwitch.classList.add('active');
        }
    }

    // Toggle auto-fill setting
    function toggleAutoFill() {
        autoFillEnabled = !autoFillEnabled;
        if (autoFillEnabled) {
            autoFillSwitch.classList.add('active');
            localStorage.setItem(AUTO_FILL_KEY, 'true');
        } else {
            autoFillSwitch.classList.remove('active');
            localStorage.setItem(AUTO_FILL_KEY, 'false');
        }
    }

    // Add listeners for settings modal close buttons
    closeSettingsModal.addEventListener('click', closeSettingsModalFunc);
    closeSettingsButton.addEventListener('click', closeSettingsModalFunc);
  </script>
</body>
</html>
